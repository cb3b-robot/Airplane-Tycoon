<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Airplane Tycoon</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body, html { margin:0; padding:0; font-family:sans-serif; height:100%; }
#map { width:100%; height:50%; }
#ui { padding:10px; background:#f0f0f0; height:50%; overflow-y:auto; }
.section { margin-bottom:10px; }
button { margin:2px; }
.notification { position:absolute; top:10px; left:50%; transform:translateX(-50%);
  background:rgba(0,0,0,0.7); color:white; padding:5px 10px; border-radius:5px; display:none; z-index:1000; }
.plane-emoji { font-size:24px; text-align:center; }
</style>
</head>
<body>

<div id="map"></div>
<div id="ui">
  <div class="section">Money: $<span id="money">0</span></div>
  <div class="section" id="airportsList"></div>
  <div class="section" id="planesList"></div>
  <div class="section">
      <button onclick="restartGame()">Restart Game</button>
      <button onclick="unlockAirport()">Unlock Airport</button>
      <button onclick="buyPlane()">Buy Plane</button>
      <button id="autoMaintainBtn" onclick="toggleAutoMaintain()" style="background:red;color:white;">Auto-Maintain: OFF</button>
  </div>
  <div class="section">
      <canvas id="profitChart" width="400" height="100"></canvas>
  </div>
</div>
<div id="notification" class="notification"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
// ================== GAME DATA ==================
let autoMaintainEnabled=false;
let moneyHistory=[];
const airportsData=[
  {code:'JFK',name:'John F. Kennedy',lat:40.6413,lon:-73.7781},
  {code:'LHR',name:'London Heathrow',lat:51.4700,lon:-0.4543},
  {code:'CDG',name:'Charles de Gaulle',lat:49.0097,lon:2.5479},
  {code:'HND',name:'Tokyo Haneda',lat:35.5494,lon:139.7798},
  {code:'SYD',name:'Sydney',lat:-33.9399,lon:151.1753}
  // ... add more up to 50
];

let gameData={
  money:100000,
  unlockedAirports:['JFK','LHR','CDG'],
  airports:[],
  planes:[{id:1,name:'Plane 1',type:'Tiny Plane',location:'JFK',destination:null,status:'idle',rating:100,maintenance:true,autoFlying:false,queue:[]}],
  planeIdCounter:2
};
gameData.airports=gameData.unlockedAirports.map(code=>({code:code,level:'Small'}));

const planeTypes=[
{name:'Tiny Plane',cost:50000,speed:0.5,capacity:50,earningsMultiplier:1},
{name:'Regional Jet',cost:200000,speed:1,capacity:100,earningsMultiplier:2},
{name:'Boeing 737',cost:500000,speed:1.5,capacity:200,earningsMultiplier:3},
{name:'Boeing 747',cost:1000000,speed:2,capacity:400,earningsMultiplier:5}];

// ================== MAP ==================
const map=L.map('map').setView([20,0],2);
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{
    attribution:'&copy; OpenStreetMap &copy; CARTO',subdomains:'abcd',maxZoom:19
}).addTo(map);

let airportMarkers={};
function updateAirports(){
  for(let code in airportMarkers) map.removeLayer(airportMarkers[code]);
  airportMarkers={};
  gameData.airports.forEach(a=>{
      const ad=airportsData.find(ad=>ad.code===a.code);
      const color=a.level==='Small'?'green':a.level==='Medium'?'orange':'red';
      const marker=L.circleMarker([ad.lat,ad.lon],{radius:8,color:color,fillOpacity:1})
        .bindPopup(`${ad.name} (${ad.code}) Level: ${a.level}`)
        .addTo(map);
      airportMarkers[a.code]=marker;
  });
}
updateAirports();

// ================== UI ==================
function updateUI(){
  document.getElementById('money').innerText=Math.floor(gameData.money);
  const airportsDiv=document.getElementById('airportsList'); airportsDiv.innerHTML='<b>Airports:</b><br>';
  gameData.airports.forEach(a=>{
    airportsDiv.innerHTML+=`${a.code} (${a.level}) <button onclick="upgradeAirport('${a.code}')">Upgrade</button><br>`;
  });

  const planesDiv=document.getElementById('planesList'); planesDiv.innerHTML='<b>Planes:</b><br>';
  gameData.planes.forEach(p=>{
      const idx=planeTypes.findIndex(pt=>pt.name===p.type);
      const next=idx<planeTypes.length-1?planeTypes[idx+1]:null;
      const upgradeText=next?`Upgrade to ${next.name} ($${next.cost})`:'Max plane';
      const maintainCost=Math.floor(planeTypes.find(pt=>pt.name===p.type).cost*0.1);
      const autoColor=p.autoFlying?'green':'red';
      const statusEmoji = p.status==='flying'?'ðŸŸ¢':'ðŸ”´';
      planesDiv.innerHTML+=`
          ${p.name} (${p.type}) ${statusEmoji} Loc: ${p.location}, Rating: ${p.rating}, Maint: ${p.maintenance?"Yes":"No"} 
          <button onclick="assignRoute(${p.id})" ${p.maintenance?"":"disabled"}>Fly</button>
          <button onclick="toggleAutoFly(${p.id})" style="background:${autoColor};color:white;">Auto</button>
          <button onclick="upgradePlane(${p.id})">${upgradeText}</button>
          <button onclick="maintainPlane(${p.id})">Maintain ($${maintainCost})</button>
          <input placeholder="Name" oninput="renamePlane(${p.id},this.value)" value="${p.name}"><br>`;
  });
}
updateUI();

// ================== Notifications ==================
function notify(msg,d=2000){ const n=document.getElementById('notification'); n.innerText=msg; n.style.display='block'; setTimeout(()=>n.style.display='none',d); }

// ================== Game Functions ==================
function saveGame(){ localStorage.setItem('airplaneTycoonSave', JSON.stringify(gameData)); }
function loadGame(){ const s=localStorage.getItem('airplaneTycoonSave'); if(s) gameData=JSON.parse(s); }
function restartGame(){ if(confirm('Restart?')){ localStorage.removeItem('airplaneTycoonSave'); location.reload(); } }
function toggleAutoMaintain(){ autoMaintainEnabled=!autoMaintainEnabled; document.getElementById('autoMaintainBtn').style.background=autoMaintainEnabled?'green':'red'; document.getElementById('autoMaintainBtn').innerText=`Auto-Maintain: ${autoMaintainEnabled?'ON':'OFF'}`; }
function renamePlane(id,name){ const p=gameData.planes.find(p=>p.id===id); if(p)p.name=name; saveGame(); updateUI(); }

// ================== Plane & Flight Functions ==================
function buyPlane(){
  const pt=planeTypes[0];
  if(gameData.money>=pt.cost){ gameData.money-=pt.cost; gameData.planes.push({id:gameData.planeIdCounter++,name:`Plane ${gameData.planeIdCounter-1}`,type:pt.name,location:gameData.unlockedAirports[0],destination:null,status:'idle',rating:100,maintenance:true,autoFlying:false,queue:[]}); updateUI(); saveGame(); notify(`Bought new ${pt.name}!`); }
  else notify(`Not enough money! Plane costs $${pt.cost}`);
}
function upgradePlane(id){ const p=gameData.planes.find(p=>p.id===id); const idx=planeTypes.findIndex(pt=>pt.name===p.type); if(idx<planeTypes.length-1){ const next=planeTypes[idx+1]; if(gameData.money>=next.cost){ gameData.money-=next.cost; p.type=next.name; p.maintenance=true; notify(`Upgraded to ${next.name}`); } else notify('Not enough money'); } else notify('Max plane'); updateUI(); saveGame(); }
function maintainPlane(id){ const p=gameData.planes.find(p=>p.id===id); const cost=planeTypes.find(pt=>pt.name===p.type).cost*0.1; if(gameData.money>=cost){ gameData.money-=cost; p.maintenance=true; p.rating=100; notify(`${p.name} maintained!`); } else notify('Not enough money'); updateUI(); saveGame(); }
function assignRoute(id){ const p=gameData.planes.find(p=>p.id===id); const dest=prompt('Enter airport code:').toUpperCase(); if(gameData.unlockedAirports.includes(dest)&&dest!==p.location){ p.queue.push(dest); if(p.status==='idle') nextFlight(p); notify(`${p.name} queued to fly to ${dest}`); } else notify('Invalid destination'); }
function toggleAutoFly(id){ const p=gameData.planes.find(p=>p.id===id); p.autoFlying=!p.autoFlying; if(p.autoFlying && p.status==='idle') autoFly(p); updateUI(); }
function autoFly(p){ const possible=gameData.unlockedAirports.filter(a=>a!==p.location); if(possible.length>0){ const dest=possible[Math.floor(Math.random()*possible.length)]; p.queue.push(dest); if(p.status==='idle') nextFlight(p); } }
function nextFlight(p){ if(p.queue.length===0){ p.status='idle'; return; } p.destination=p.queue.shift(); p.status='flying'; flyPlane(p); }

function flyPlane(p){
  const start=airportsData.find(a=>a.code===p.location);
  const end=airportsData.find(a=>a.code===p.destination);
  if(!start||!end) return;
  const icon=L.divIcon({html:'âœˆï¸',className:'plane-emoji',iconSize:[30,30]});
  const path=L.polyline([[start.lat,start.lon],[end.lat,end.lon]],{color:p.autoFlying?'green':'blue'}).addTo(map);
  const marker=L.marker([start.lat,start.lon],{icon:icon}).addTo(map);
  const steps=50,latStep=(end.lat-start.lat)/steps,lonStep=(end.lon-start.lon)/steps;
  let step=0;
  const interval=setInterval(()=>{
    step++; marker.setLatLng([start.lat+latStep*step,start.lon+lonStep*step]);
    if(step>=steps){ clearInterval(interval); map.removeLayer(marker); map.removeLayer(path); p.location=p.destination; p.destination=null; p.status='idle'; p.maintenance=false;
      const earnings=Math.floor(calculateEarnings(p,start,end)); gameData.money+=earnings;
      p.rating-=Math.floor(Math.random()*10); flightEvent(p); if(autoMaintainEnabled && !p.maintenance){ const cost=planeTypes.find(pt=>pt.name===p.type).cost*0.1; if(gameData.money>=cost){ gameData.money-=cost; p.maintenance=true; p.rating=100; notify(`${p.name} auto-maintained for $${Math.floor(cost)}`); } }
      notify(`Flight complete! Earned $${earnings}`); moneyHistory.push(gameData.money); updateUI(); saveGame(); updateProfitChart(); if(p.autoFlying && p.status==='idle') autoFly(p); if(p.queue.length>0 && p.status==='idle') nextFlight(p); 
    }
  },1000/planeTypes.find(pt=>pt.name===p.type).speed);
}

function calculateEarnings(p,start,end){
    const d=getDistance(start.lat,start.lon,end.lat,end.lon);
    const pt=planeTypes.find(pt=>pt.name===p.type);
    const destAirport=gameData.airports.find(a=>a.code===end.code);
    let levelMultiplier=1;
    if(destAirport){
        if(destAirport.level==='Medium') levelMultiplier=1.5;
        else if(destAirport.level==='Large') levelMultiplier=2;
    }
    return d*10*pt.earningsMultiplier*(p.rating/100)*levelMultiplier;
}

function getDistance(lat1,lon1,lat2,lon2){ const R=6371; const dLat=(lat2-lat1)*Math.PI/180; const dLon=(lon2-lon1)*Math.PI/180; const a=Math.sin(dLat/2)**2+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2; const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)); return R*c; }

function flightEvent(plane){ const r=Math.random(); if(r<0.1){ plane.rating-=5; notify('Passengers unhappy due to turbulence!'); } else if(r<0.2){ gameData.money+=500; notify('Good weather! Extra $500 earned'); } }

function upgradeAirport(code){
    const airport=gameData.airports.find(a=>a.code===code);
    if(!airport) return notify('Airport not found');
    const levels=['Small','Medium','Large'];
    const idx=levels.indexOf(airport.level);
    if(idx>=levels.length-1) return notify('Max level reached');
    const cost=50000+10000*gameData.unlockedAirports.length+50000*idx;
    if(gameData.money>=cost){ gameData.money-=cost; airport.level=levels[idx+1]; notify(`${code} upgraded to ${airport.level} airport for $${cost}`); updateAirports(); updateUI(); saveGame(); }
    else notify(`Not enough money! Upgrade costs $${cost}`);
}

// ================== Passive Income ==================
function passiveIncomeTick(){
  let income=0;
  gameData.airports.forEach(a=>{
    if(a.level==='Small') income+=500;
    else if(a.level==='Medium') income+=1000;
    else if(a.level==='Large') income+=2000;
  });
  gameData.money+=income;
  moneyHistory.push(gameData.money);
  updateUI(); updateProfitChart(); saveGame();
}
setInterval(passiveIncomeTick,5000);

// Profit Chart
const ctx=document.getElementById('profitChart').getContext('2d');
const profitChart=new Chart(ctx,{type:'line',data:{labels:[],datasets:[{label:'Money Over Time',data:[],borderColor:'green',fill:false}]},options:{responsive:true,scales:{y:{beginAtZero:true}}}});
function updateProfitChart(){ const labels=moneyHistory.map((_,i)=>i); profitChart.data.labels=labels; profitChart.data.datasets[0].data=moneyHistory; profitChart.update(); }

updateProfitChart();
</script>

</body>
</html>
