<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Airplane Tycoon ‚Äì Single File MVP</title>

<!-- Leaflet (Map) -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
  crossorigin=""
/>
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""
></script>

<!-- Chart.js (Money over time) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
  :root{
    --bg:#0f1221;
    --panel:#171a2e;
    --panel2:#1f2342;
    --text:#e9ecff;
    --muted:#a9b0d9;
    --accent:#60a5fa;
    --good:#22c55e;
    --bad:#ef4444;
    --warn:#f59e0b;
  }
  *{box-sizing:border-box}
  body{
    margin:0; background:var(--bg); color:var(--text);
    font:14px/1.3 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    display:grid; grid-template-rows:auto 1fr 180px; height:100vh;
    grid-template-columns:320px 1fr 360px;
    grid-template-areas:
      "topbar topbar topbar"
      "left   map    right"
      "log    log    right";
  }
  #topbar{ grid-area:topbar; display:flex; align-items:center; gap:12px;
    padding:10px 12px; background:linear-gradient(90deg, #14173a, #1b1f4a);}
  #left{ grid-area:left; background:var(--panel); overflow:auto; border-right:1px solid #2c3366;}
  #map{ grid-area:map;}
  #right{ grid-area:right; background:var(--panel); overflow:auto; border-left:1px solid #2c3366;}
  #log{ grid-area:log; background:var(--panel2); overflow:auto; border-top:1px solid #2c3366; padding:8px 10px;}
  .stat{background:var(--panel2); padding:8px 10px; border-radius:8px; display:flex; gap:8px; align-items:center}
  .pill{padding:2px 8px; border-radius:999px; font-size:12px; background:#2a2f5e; color:var(--muted)}
  .money{font-weight:700; color:#b4e07c; font-size:18px}
  button, select{
    background:#2a2f5e; color:var(--text); border:1px solid #38407b; border-radius:8px; padding:6px 10px; cursor:pointer;
  }
  button:disabled{opacity:.5; cursor:not-allowed}
  .panel{padding:10px 12px; border-bottom:1px solid #2c3366}
  h3{margin:8px 0 6px; font-size:15px; color:#c8cffc}
  .row{display:flex; align-items:center; justify-content:space-between; gap:8px; margin:6px 0}
  .small{font-size:12px; color:var(--muted)}
  .airport{padding:8px; margin:8px 0; background:#1a1f3d; border:1px solid #2c3366; border-radius:10px}
  .plane{padding:8px; margin:8px 0; background:#1a1f3d; border:1px solid #2c3366; border-radius:10px}
  .badge{font-size:12px; background:#233; padding:2px 6px; border-radius:6px; color:#bcd}
  .ok{color:var(--good)} .warn{color:var(--warn)} .bad{color:var(--bad)}
  .flex{display:flex; gap:8px; flex-wrap:wrap}
  .divider{height:1px; background:#2c3366; margin:10px 0}
  #moneyChart{ width:100%; height:120px;}
  .toggle{display:inline-flex; align-items:center; gap:6px}
  .toggle input{accent-color:var(--accent)}
  a{color:#9cc1ff}
  .legend{font-size:12px; color:var(--muted)}
  .sticky{position:sticky; top:0; background:var(--panel); z-index:3; padding-top:10px;}
</style>
</head>
<body>

<!-- Top bar -->
<div id="topbar">
  <div class="stat">
    üí∞ <span class="small">Money</span> <span id="money" class="money">$0</span>
  </div>
  <div class="stat">
    üõ´ <span class="small">Planes</span> <span id="planeCount" class="pill">0</span>
  </div>
  <div class="stat">
    üó∫Ô∏è <span class="small">Airports</span> <span id="airportCount" class="pill">0</span>
  </div>
  <div class="stat">
    ‚è±Ô∏è <span class="small">Game Speed</span>
    <select id="speedSelect" title="Game speed">
      <option value="1">1√ó</option>
      <option value="2">2√ó</option>
      <option value="4">4√ó</option>
      <option value="8">8√ó</option>
    </select>
  </div>
  <div class="stat">
    ‚õëÔ∏è <span class="small">Auto-Maintain</span>
    <label class="toggle"><input type="checkbox" id="autoMaintain"> on</label>
  </div>
  <div class="stat">
    üå¶Ô∏è <span class="small">Active Event</span>
    <span id="activeEvent" class="pill">None</span>
  </div>
</div>

<!-- Left: Airports / Shop / Missions -->
<div id="left">
  <div class="panel sticky">
    <h3>Airports & Shop</h3>
    <div class="small">Unlock airports to expand your network. Storms can temporarily close some.</div>
    <div class="divider"></div>
    <div class="row">
      <button id="buyBasicPlane">Buy Plane ‚úàÔ∏è ($15,000)</button>
      <span class="small">Type: Commuter</span>
    </div>
    <div class="row">
      <button id="buyJetPlane">Buy Jet üõ©Ô∏è ($80,000)</button>
      <span class="small">Type: Regional Jet</span>
    </div>
  </div>
  <div id="airportsList" class="panel">
    <!-- Airports injected here -->
  </div>
  <div class="panel">
    <h3>Missions</h3>
    <div id="missions"></div>
  </div>
  <div class="panel">
    <h3>Achievements</h3>
    <div id="achievements"></div>
  </div>
  <div class="panel">
    <h3>Money Chart</h3>
    <canvas id="moneyChart"></canvas>
  </div>
  <div class="panel">
    <div class="legend">Map legend: üõ´ plane ‚Ä¢ üìç airport (locked) ‚Ä¢ üü¢ open ‚Ä¢ üî¥ closed</div>
  </div>
</div>

<!-- Map -->
<div id="map"></div>

<!-- Right: Planes -->
<div id="right">
  <div class="panel sticky">
    <h3>Your Fleet</h3>
    <div class="small">Click ‚ÄúFly‚Äù to choose a route. Toggle Auto-Fly to loop between random unlocked airports.</div>
  </div>
  <div id="planesList" class="panel"></div>
</div>

<!-- Bottom: Log -->
<div id="log"></div>

<script>
/* =========================
   Utility
==========================*/
const fmt = n => '$' + n.toLocaleString();
const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
const nowSec = () => Math.floor(Date.now()/1000);

// Haversine distance in km
function distKm(a, b){
  const R = 6371;
  const dLat = (b.lat-a.lat)*Math.PI/180;
  const dLon = (b.lon-a.lon)*Math.PI/180;
  const la1 = a.lat*Math.PI/180, la2 = b.lat*Math.PI/180;
  const x = Math.sin(dLat/2)**2 + Math.cos(la1)*Math.cos(la2)*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(x));
}

/* =========================
   Game Data
==========================*/
const DEFAULT_STATE = {
  money: 100000,
  gameSpeed: 1,
  autoMaintain: false,
  airports: [],      // {id, name, code, lat, lon, unlocked, cost, closedUntil}
  planes: [],        // {id, typeId, name, atAirportId, toAirportId, departAt, arriveAt, wear, autoFly, lastFlightProfit}
  events: {active:null, endsAt:0}, // {type:'holiday'|'storm', meta:{}, endsAt}
  missions: [],      // {id, text, target, progress, reward, done}
  achievements: [],  // {id, text, done, reward}
  moneySeries: [],   // [{t, v}]
  version: 1
};

const PLANE_TYPES = {
  commuter: { label:'Commuter', price:15000, speedKmH:500, capacity:28, fuelPerKm:2, wearPerKm:0.020, upgradeCost:8000, maxLevel:3 },
  rjet:     { label:'Regional Jet', price:80000, speedKmH:750, capacity:80, fuelPerKm:4, wearPerKm:0.015, upgradeCost:20000, maxLevel:3 },
};

const AIRPORTS_SEED = [
  {id:'JFK', name:'New York JFK',   code:'JFK', lat:40.6413, lon:-73.7781, cost:0},
  {id:'LAX', name:'Los Angeles',    code:'LAX', lat:33.9416, lon:-118.4085, cost:12000},
  {id:'ORD', name:'Chicago O‚ÄôHare', code:'ORD', lat:41.9742, lon:-87.9073, cost:9000},
  {id:'DFW', name:'Dallas‚ÄìFort Worth', code:'DFW', lat:32.8998, lon:-97.0403, cost:8000},
  {id:'ATL', name:'Atlanta',        code:'ATL', lat:33.6407, lon:-84.4277, cost:8000},
  {id:'LHR', name:'London Heathrow',code:'LHR', lat:51.4700, lon:-0.4543, cost:15000},
  {id:'CDG', name:'Paris CDG',      code:'CDG', lat:49.0097, lon:2.5479, cost:14000},
  {id:'HND', name:'Tokyo Haneda',   code:'HND', lat:35.5494, lon:139.7798, cost:18000},
  {id:'DXB', name:'Dubai',          code:'DXB', lat:25.2532, lon:55.3657, cost:16000},
  {id:'SYD', name:'Sydney',         code:'SYD', lat:-33.9399, lon:151.1753, cost:17000},
];

const MISSIONS_SEED = [
  {id:'m1', text:'Complete your first flight', target:1, progress:0, reward:5000},
  {id:'m2', text:'Earn $50,000 total', target:50000, progress:0, reward:7000, type:'money'},
  {id:'m3', text:'Unlock 5 airports', target:5, progress:0, reward:10000, type:'airports'},
];

const ACHIEVEMENTS_SEED = [
  {id:'a1', text:'First Plane Purchased', done:false, reward:1000},
  {id:'a2', text:'Own 3 Planes', done:false, reward:3000},
  {id:'a3', text:'Unlock International (LHR/CDG/HND/DXB/SYD)', done:false, reward:8000},
  {id:'a4', text:'Maintain a plane before it breaks', done:false, reward:2000},
];

/* =========================
   State & Save/Load
==========================*/
let S = load() || initNew();

function initNew(){
  const st = structuredClone(DEFAULT_STATE);
  st.airports = AIRPORTS_SEED.map((a,i)=>({...a, unlocked:i===0, closedUntil:0}));
  st.planes = [];
  st.events = {active:null, endsAt:0};
  st.missions = structuredClone(MISSIONS_SEED);
  st.achievements = structuredClone(ACHIEVEMENTS_SEED);
  st.moneySeries = [{t:nowSec(), v:st.money}];
  return st;
}
function save(){ localStorage.setItem('airplane_tycoon_mvp', JSON.stringify(S)); }
function load(){
  try{ return JSON.parse(localStorage.getItem('airplane_tycoon_mvp')); }
  catch{ return null; }
}

/* =========================
   Map
==========================*/
const map = L.map('map', { zoomControl:true }).setView([30,0], 2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution:'&copy; OpenStreetMap contributors'
}).addTo(map);

const airportMarkers = new Map(); // id -> marker
const planeMarkers = new Map();   // id -> marker

function refreshAirportMarkers(){
  S.airports.forEach(ap=>{
    if(airportMarkers.has(ap.id)){
      const m = airportMarkers.get(ap.id);
      m.setLatLng([ap.lat, ap.lon]);
      m.setIcon(airportIcon(ap));
      m.bindTooltip(`${ap.name} (${ap.code}) ${ap.unlocked?'üü¢':'üìç'} ${apClosed(ap)?'üî¥ Storm':''}`);
    }else{
      const m = L.marker([ap.lat, ap.lon], {icon:airportIcon(ap)})
        .addTo(map)
        .bindTooltip(`${ap.name} (${ap.code}) ${ap.unlocked?'üü¢':'üìç'} ${apClosed(ap)?'üî¥ Storm':''}`);
      airportMarkers.set(ap.id, m);
    }
  });
}
function airportIcon(ap){
  const emoji = ap.unlocked ? 'üü¢' : 'üìç';
  const closed = apClosed(ap) ? 'üî¥' : '';
  return L.divIcon({className:'', html:`<div style="font-size:20px">${closed||emoji}</div>`});
}
function apClosed(ap){
  return ap.closedUntil && ap.closedUntil > nowSec();
}

function refreshPlaneMarkers(){
  // Remove missing
  [...planeMarkers.keys()].forEach(id=>{
    if(!S.planes.find(p=>p.id===id)){ map.removeLayer(planeMarkers.get(id)); planeMarkers.delete(id); }
  });
  S.planes.forEach(p=>{
    const pos = planePosition(p);
    if(planeMarkers.has(p.id)){
      planeMarkers.get(p.id).setLatLng([pos.lat, pos.lon]).setIcon(planeIcon(p))
        .bindTooltip(`${p.name} (${PLANE_TYPES[p.typeId].label})`);
    }else{
      const m = L.marker([pos.lat, pos.lon], {icon:planeIcon(p)})
        .addTo(map)
        .bindTooltip(`${p.name} (${PLANE_TYPES[p.typeId].label})`);
      planeMarkers.set(p.id, m);
    }
  });
}
function planeIcon(p){
  const emoji = '‚úàÔ∏è';
  return L.divIcon({className:'', html:`<div style="font-size:18px">${emoji}</div>`});
}
function planePosition(p){
  if(!p.toAirportId || !p.departAt || nowSec() <= p.departAt){
    const ap = getAirport(p.atAirportId);
    return {lat:ap.lat, lon:ap.lon};
  }
  const from = getAirport(p.atAirportId);
  const to = getAirport(p.toAirportId);
  const t = clamp((nowSec() - p.departAt) / Math.max(1,(p.arriveAt - p.departAt)), 0, 1);
  // simple linear interpolation for display
  return {lat: from.lat + (to.lat-from.lat)*t, lon: from.lon + (to.lon-from.lon)*t};
}

/* =========================
   UI Rendering
==========================*/
const elMoney = document.getElementById('money');
const elPlaneCount = document.getElementById('planeCount');
const elAirportCount = document.getElementById('airportCount');
const elAirports = document.getElementById('airportsList');
const elPlanes = document.getElementById('planesList');
const elLog = document.getElementById('log');
const elSpeed = document.getElementById('speedSelect');
const elAutoMaintain = document.getElementById('autoMaintain');
const elActiveEvent = document.getElementById('activeEvent');
const buyBasicPlaneBtn = document.getElementById('buyBasicPlane');
const buyJetPlaneBtn = document.getElementById('buyJetPlane');

function renderTop(){
  elMoney.textContent = fmt(Math.floor(S.money));
  elPlaneCount.textContent = String(S.planes.length);
  elAirportCount.textContent = String(S.airports.filter(a=>a.unlocked).length);
  elSpeed.value = String(S.gameSpeed);
  elAutoMaintain.checked = S.autoMaintain;
  elActiveEvent.textContent = S.events.active ? (S.events.active==='holiday'?'Holiday üéâ':'Storm üå©Ô∏è') : 'None';
}

function renderAirports(){
  elAirports.innerHTML = '<h3>Airports</h3>';
  S.airports.forEach(ap=>{
    const wrap = document.createElement('div'); wrap.className='airport';
    const closed = apClosed(ap) ? ' <span class="badge bad">Closed (Storm)</span>' : '';
    wrap.innerHTML = `
      <div class="row"><strong>${ap.name}</strong> <span class="badge">${ap.code}</span></div>
      <div class="small">Lat ${ap.lat.toFixed(2)}, Lon ${ap.lon.toFixed(2)} ${closed}</div>
      <div class="row">
        <span>${ap.unlocked ? '<span class="ok">Unlocked</span>' : 'Unlock cost: <b>'+fmt(ap.cost)+'</b>'}</span>
        ${ap.unlocked ? '' : `<button data-unlock="${ap.id}">Unlock</button>`}
      </div>
    `;
    elAirports.appendChild(wrap);
  });
  elAirports.querySelectorAll('button[data-unlock]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const id = btn.getAttribute('data-unlock');
      unlockAirport(id);
    });
  });
}

function renderPlanes(){
  elPlanes.innerHTML = '';
  S.planes.forEach(p=>{
    const type = PLANE_TYPES[p.typeId];
    const at = getAirport(p.atAirportId);
    const to = p.toAirportId ? getAirport(p.toAirportId) : null;
    const inflight = p.toAirportId && nowSec() < p.arriveAt;
    const wearPct = Math.round(p.wear*100);
    const canFly = at && !apClosed(at);
    const wrap = document.createElement('div'); wrap.className='plane';
    wrap.innerHTML = `
      <div class="row">
        <strong>${p.name}</strong>
        <span class="badge">${type.label}</span>
      </div>
      <div class="small">At: ${at ? at.code : '‚Äî'} ${to ? '‚Üí '+to.code : ''}</div>
      <div class="row">
        <span>Wear: <b class="${wearPct<60?'ok':wearPct<85?'warn':'bad'}">${wearPct}%</b></span>
        <button data-maintain="${p.id}">Maintain (${fmt(maintenanceCost(p))})</button>
      </div>
      <div class="row">
        <span>Last Profit: <b>${p.lastFlightProfit?fmt(p.lastFlightProfit):'‚Äî'}</b></span>
        <button data-upgrade="${p.id}">Upgrade (${fmt(upgradeCost(p))})</button>
      </div>
      <div class="row">
        <button data-fly="${p.id}" ${(!canFly||inflight)?'disabled':''}>Fly</button>
        <label class="toggle">
          <input type="checkbox" data-autofly="${p.id}" ${p.autoFly?'checked':''}/> Auto-Fly
        </label>
      </div>
    `;
    elPlanes.appendChild(wrap);
  });

  elPlanes.querySelectorAll('button[data-maintain]').forEach(b=>{
    b.onclick = ()=> maintainPlane(b.getAttribute('data-maintain'));
  });
  elPlanes.querySelectorAll('button[data-upgrade]').forEach(b=>{
    b.onclick = ()=> upgradePlane(b.getAttribute('data-upgrade'));
  });
  elPlanes.querySelectorAll('button[data-fly]').forEach(b=>{
    b.onclick = ()=> promptFlight(b.getAttribute('data-fly'));
  });
  elPlanes.querySelectorAll('input[data-autofly]').forEach(ch=>{
    ch.onchange = ()=> toggleAutofly(ch.getAttribute('data-autofly'), ch.checked);
  });
}

function log(msg){
  const line = document.createElement('div');
  line.innerHTML = `<span class="small">${new Date().toLocaleTimeString()}</span> ‚Äî ${msg}`;
  elLog.prepend(line);
}

/* =========================
   Buying / Upgrading / Maintenance
==========================*/
let planeIdCounter = 1;

function buyPlane(typeId){
  const type = PLANE_TYPES[typeId];
  if(S.money < type.price){ log(`‚ùå Not enough money to buy ${type.label}.`); return; }
  S.money -= type.price;
  const firstAirport = S.airports.find(a=>a.unlocked);
  const plane = {
    id:'P'+(planeIdCounter++),
    typeId, name: type.label+' #'+Math.floor(Math.random()*90+10),
    level:1,
    atAirportId:firstAirport.id, toAirportId:null,
    departAt:0, arriveAt:0,
    wear:0, autoFly:false, lastFlightProfit:0
  };
  S.planes.push(plane);
  checkAchievements();
  log(`üõ©Ô∏è Purchased ${type.label}.`);
  renderAll(); save();
}
function upgradeCost(p){
  const base = PLANE_TYPES[p.typeId].upgradeCost;
  return p.level>=PLANE_TYPES[p.typeId].maxLevel ? Infinity : Math.round(base * p.level);
}
function maintenanceCost(p){
  return Math.round(500 + 5000*p.wear);
}
function upgradePlane(id){
  const p = S.planes.find(x=>x.id===id);
  if(!p) return;
  const cost = upgradeCost(p);
  if(!isFinite(cost)){ log('‚úÖ Already max level.'); return; }
  if(S.money < cost){ log('‚ùå Not enough money to upgrade.'); return; }
  S.money -= cost;
  p.level++;
  // simple upgrade effects
  // +15% capacity and +10% speed per level
  log(`üîß Upgraded ${p.name} to level ${p.level}.`);
  renderAll(); save();
}
function maintainPlane(id){
  const p = S.planes.find(x=>x.id===id);
  if(!p) return;
  const cost = maintenanceCost(p);
  if(S.money < cost){ log('‚ùå Not enough money for maintenance.'); return; }
  S.money -= cost;
  p.wear = 0;
  // achievement: maintenance
  if(!S.achievements.find(a=>a.id==='a4').done){
    completeAchievement('a4');
  }
  log(`üõ†Ô∏è Maintained ${p.name} for ${fmt(cost)}.`);
  renderAll(); save();
}

/* =========================
   Airports
==========================*/
function getAirport(id){ return S.airports.find(a=>a.id===id); }
function unlockAirport(id){
  const ap = getAirport(id); if(!ap) return;
  if(ap.unlocked){ log('Already unlocked.'); return; }
  if(S.money < ap.cost){ log(`‚ùå Need ${fmt(ap.cost)} to unlock ${ap.code}.`); return; }
  S.money -= ap.cost; ap.unlocked = true;
  log(`üìç Unlocked ${ap.name} (${ap.code}).`);
  refreshAirportMarkers();
  checkAchievements();
  S.missions.find(m=>m.id==='m3').progress = S.airports.filter(a=>a.unlocked).length;
  renderAll(); save();
}

/* =========================
   Flights
==========================*/
function effectiveStats(p){
  const t = PLANE_TYPES[p.typeId];
  const speed = t.speedKmH * (1 + 0.10*(p.level-1));
  const capacity = Math.round(t.capacity * (1 + 0.15*(p.level-1)));
  const fuelPerKm = t.fuelPerKm * (1 - 0.05*(p.level-1));
  return {speed, capacity, fuelPerKm};
}

function promptFlight(planeId){
  const p = S.planes.find(x=>x.id===planeId); if(!p) return;
  const unlocked = S.airports.filter(a=>a.unlocked && a.id!==p.atAirportId && !apClosed(a));
  if(unlocked.length===0){ log('No available destination (airports locked or storm-closed).'); return; }
  // Quick picker: first 6 by distance
  const from = getAirport(p.atAirportId);
  const options = unlocked
    .map(a=>({a, d: distKm({lat:from.lat, lon:from.lon}, {lat:a.lat, lon:a.lon})}))
    .sort((x,y)=>x.d-y.d)
    .slice(0,6);
  const names = options.map(o=>`${o.a.code} (${o.a.name}) ‚Äì ${o.d.toFixed(0)} km`).join('\n');
  const pick = prompt(`Choose destination code:\n${names}\n\nType airport CODE (e.g., LAX)`, options[0]?.a.code || '');
  if(!pick) return;
  const dest = S.airports.find(a=>a.code.toUpperCase()===pick.toUpperCase() && a.unlocked && !apClosed(a));
  if(!dest){ log('Invalid or unavailable destination.'); return; }
  scheduleFlight(p, dest.id);
}

function scheduleFlight(p, destId){
  const from = getAirport(p.atAirportId), to = getAirport(destId);
  if(apClosed(to)){ log('Destination is storm-closed.'); return; }
  const {speed} = effectiveStats(p);
  const d = distKm(from, to);
  const hours = d / Math.max(50, speed);
  const sec = Math.max(10, hours*3600*0.06); // scale down to be playable
  p.toAirportId = destId;
  p.departAt = nowSec();
  p.arriveAt = p.departAt + Math.floor(sec / S.gameSpeed);
  log(`üõ´ ${p.name} departing ${from.code} ‚Üí ${to.code} (${d.toFixed(0)} km, ETA ${Math.round(sec/S.gameSpeed)}s).`);
  renderAll(); save();
}

function arrivePlane(p){
  const from = getAirport(p.atAirportId), to = getAirport(p.toAirportId);
  const {capacity, fuelPerKm} = effectiveStats(p);
  const d = distKm(from, to);
  const demandBoost = (S.events.active==='holiday') ? 1.35 : 1.0;
  const baseFare = 0.9;                 // $/km per pax baseline
  const pax = Math.round(capacity * (0.6 + Math.random()*0.4) * demandBoost);
  const revenue = pax * baseFare * d;
  const fuelCost = fuelPerKm * d * 0.8;
  const wearInc = (PLANE_TYPES[p.typeId].wearPerKm) * d / 100; // small
  const maintPenalty = p.wear>0.9 ? 0.6 : 1.0; // very worn planes underperform
  const profit = Math.round((revenue*maintPenalty) - fuelCost);

  S.money += profit;
  p.wear = clamp(p.wear + wearInc, 0, 1);
  p.atAirportId = p.toAirportId;
  p.toAirportId = null;
  p.departAt = 0; p.arriveAt = 0;
  p.lastFlightProfit = profit;

  // Missions
  S.missions.find(m=>m.id==='m1').progress = Math.min(1, (S.missions.find(m=>m.id==='m1').progress||0)+1);
  const m2 = S.missions.find(m=>m.id==='m2'); m2.progress = Math.min(m2.target, m2.progress + Math.max(0, profit));

  if(S.autoMaintain && p.wear>0.5) tryAutoMaintain(p);

  log(`üõ¨ ${p.name} landed at ${getAirport(p.atAirportId).code}: ${profit>=0?'Profit':'Loss'} ${fmt(profit)} (pax ${pax}).`);
  completeMissionsIfReady();
  renderAll(); save();
}

function tryAutoMaintain(p){
  const cost = maintenanceCost(p);
  if(S.money >= cost){
    S.money -= cost; p.wear = 0;
    log(`üõ†Ô∏è Auto-maintained ${p.name} for ${fmt(cost)}.`);
  }
}

/* =========================
   Auto-Fly
==========================*/
function toggleAutofly(id, val){
  const p = S.planes.find(x=>x.id===id); if(!p) return;
  p.autoFly = !!val;
  renderPlanes(); save();
}
function stepAutofly(p){
  if(p.toAirportId) return; // currently in flight
  const opts = S.airports.filter(a=>a.unlocked && a.id!==p.atAirportId && !apClosed(a));
  if(opts.length===0) return;
  const choice = opts[Math.floor(Math.random()*opts.length)];
  scheduleFlight(p, choice.id);
}

/* =========================
   Events (Holiday / Storm)
==========================*/
function maybeStartEvent(){
  if(S.events.active) return;
  // small chance every 30s
  if(Math.random() < 0.08){
    const type = Math.random()<0.5 ? 'holiday' : 'storm';
    const duration = Math.floor(60 + Math.random()*60); // 1‚Äì2 minutes
    S.events.active = type;
    S.events.endsAt = nowSec() + Math.floor(duration / S.gameSpeed);
    if(type==='storm'){
      // close 1‚Äì3 random unlocked airports (not all!)
      const open = S.airports.filter(a=>a.unlocked);
      const count = Math.min(3, Math.max(1, Math.floor(Math.random()*3)+1, open.length-1));
      shuffle(open).slice(0,count).forEach(a=>{
        a.closedUntil = S.events.endsAt;
      });
      log(`üå©Ô∏è Storm event! Some airports closed for ~${duration}s.`);
    }else{
      log(`üéâ Holiday event! Demand & fares boosted for ~${duration}s.`);
    }
  }
}
function updateEvent(){
  if(S.events.active && nowSec() >= S.events.endsAt){
    S.events.active = null; S.events.endsAt = 0;
    log('‚úÖ Event ended.');
    // reopen handled by closedUntil timestamps naturally expiring
  }
}
function shuffle(arr){ return arr.map(v=>[Math.random(),v]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]); }

/* =========================
   Missions & Achievements
==========================*/
function completeMissionsIfReady(){
  S.missions.forEach(m=>{
    if(m.done) return;
    const val = m.type==='money' ? m.progress : m.progress;
    if(val >= m.target){
      m.done = true; S.money += m.reward;
      log(`üèÅ Mission complete: ${m.text} (+${fmt(m.reward)})`);
    }
  });
}
function checkAchievements(){
  // a1: First plane
  const a1 = S.achievements.find(a=>a.id==='a1');
  if(!a1.done && S.planes.length>=1) completeAchievement('a1');
  // a2: Own 3 planes
  const a2 = S.achievements.find(a=>a.id==='a2');
  if(!a2.done && S.planes.length>=3) completeAchievement('a2');
  // a3: unlock any one of the listed
  const a3 = S.achievements.find(a=>a.id==='a3');
  const intl = ['LHR','CDG','HND','DXB','SYD'];
  if(!a3.done && intl.some(id=>getAirport(id).unlocked)) completeAchievement('a3');
}
function completeAchievement(id){
  const a = S.achievements.find(x=>x.id===id);
  if(!a || a.done) return;
  a.done = true; if(a.reward){ S.money += a.reward; }
  log(`üèÜ Achievement unlocked: ${a.text}${a.reward?` (+${fmt(a.reward)})`:''}`);
  renderAll(); save();
}

/* =========================
   Chart
==========================*/
const moneyCtx = document.getElementById('moneyChart');
const moneyChart = new Chart(moneyCtx, {
  type:'line',
  data:{ labels:[], datasets:[{label:'Money', data:[], tension:0.2}]},
  options:{ responsive:true, maintainAspectRatio:false, scales:{ x:{display:false } } }
});
function pushMoneySample(){
  const t = nowSec();
  S.moneySeries.push({t, v: Math.floor(S.money)});
  if(S.moneySeries.length>240) S.moneySeries.shift();
  moneyChart.data.labels = S.moneySeries.map(p=>p.t);
  moneyChart.data.datasets[0].data = S.moneySeries.map(p=>p.v);
  moneyChart.update();
}

/* =========================
   Render Helpers
==========================*/
function renderMissions(){
  const box = document.getElementById('missions');
  box.innerHTML = '';
  S.missions.forEach(m=>{
    const div = document.createElement('div');
    div.className='row';
    const prog = Math.min(1, (m.type==='money' ? (m.progress/m.target) : (m.progress/m.target))) * 100;
    div.innerHTML = `<span>${m.done?'‚úÖ':'‚¨úÔ∏è'} ${m.text} ${m.type==='money'?'('+fmt(m.progress)+'/'+fmt(m.target)+')':`(${m.progress}/${m.target})`}</span>
                     <span class="small">Reward: ${fmt(m.reward)}</span>`;
    box.appendChild(div);
  });
}
function renderAchievements(){
  const box = document.getElementById('achievements');
  box.innerHTML = '';
  S.achievements.forEach(a=>{
    const div = document.createElement('div');
    div.className='row';
    div.innerHTML = `<span>${a.done?'üèÜ':'üîí'} ${a.text}</span><span class="small">${a.reward?fmt(a.reward):''}</span>`;
    box.appendChild(div);
  });
}
function renderAll(){
  renderTop();
  renderAirports();
  renderPlanes();
  refreshAirportMarkers();
  refreshPlaneMarkers();
  renderMissions();
  renderAchievements();
}

/* =========================
   Game Loop
==========================*/
let tickHandle = null;
function tick(){
  // Arrivals
  S.planes.forEach(p=>{
    if(p.toAirportId && nowSec() >= p.arriveAt){
      arrivePlane(p);
    }
  });
  // Auto fly
  S.planes.forEach(p=>{
    if(p.autoFly && !p.toAirportId){
      stepAutofly(p);
    }
  });
  // Events
  maybeStartEvent();
  updateEvent();

  // sample money occasionally
  if(Math.random()<0.2) pushMoneySample();

  refreshPlaneMarkers();
  renderTop();
  save();
}
function startLoop(){
  if(tickHandle) clearInterval(tickHandle);
  tickHandle = setInterval(tick, 1000);
}

/* =========================
   Controls
==========================*/
document.getElementById('buyBasicPlane').onclick = ()=> buyPlane('commuter');
document.getElementById('buyJetPlane').onclick   = ()=> buyPlane('rjet');
document.getElementById('speedSelect').onchange = (e)=>{ S.gameSpeed = Number(e.target.value); save(); log(`‚è±Ô∏è Game speed set to ${S.gameSpeed}√ó.`); };
document.getElementById('autoMaintain').onchange = (e)=>{ S.autoMaintain = e.target.checked; save(); log(`‚õëÔ∏è Auto-Maintain ${S.autoMaintain?'enabled':'disabled'}.`); };

/* =========================
   Boot
==========================*/
(function boot(){
  // ensure first airport unlocked
  if(!S.airports.some(a=>a.unlocked)){ S.airports[0].unlocked = true; }
  renderAll();
  // initial sample
  pushMoneySample();
  startLoop();
  log('üëã Welcome! Buy a plane, unlock an airport, and start flying.');
})();
</script>
</body>
</html>
