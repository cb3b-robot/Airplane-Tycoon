<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Airplane Tycoon</title>

<!-- Leaflet (Map) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- Chart.js (Profit chart) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  html, body { height: 100%; margin: 0; font-family: Arial, sans-serif; }
  #map { height: 50vh; width: 100%; } /* ensures map is visible */
  #ui { padding: 10px; }
  button { margin: 2px; }
  #notifications { position: fixed; bottom: 10px; right: 10px; width: 300px; z-index: 999; }
  .notification { background: #333; color: #fff; padding: 6px 10px; margin-top: 6px; border-radius: 6px; opacity: .95; }
  .plane-marker { font-size: 18px; }
  .section { margin-top: 10px; }
  .dim { opacity: 0.85; }
</style>
</head>
<body>

<!-- Map -->
<div id="map"></div>

<!-- UI -->
<div id="ui">
  <h2>Airplane Tycoon</h2>
  <div>Money: $<span id="money">150000</span></div>
  <div>Time: <span id="gameTime">06:00</span> | Day: <span id="gameDay">1</span></div>

  <div class="section">
    <button onclick="buyPlane()">Buy Plane ($50,000)</button>
    <label class="dim" id="autoFlyLabel">
      <input type="checkbox" id="autoFlyToggle" onchange="toggleAutoFly()"> Auto-Fly
    </label>
  </div>

  <div class="section">
    <h3>Airports</h3>
    <div id="airportList"></div>
  </div>

  <div class="section">
    <h3>Planes</h3>
    <div id="planeList"></div>
  </div>

  <div class="section">
    <h3>Profit Chart</h3>
    <canvas id="profitChart" width="400" height="200"></canvas>
  </div>
</div>

<div id="notifications"></div>

<script>
/* -------------------- Game State -------------------- */
let gameState = { money: 150000, airports: [], planes: [] };
let autoFly = false;                 // global auto-fly toggle
let planeMarkers = {};               // name -> Leaflet marker
let flightLines = {};                // name -> Leaflet polyline
let currentEvent = null;             // random event affecting revenue
let planeDeliveredCount = 0;         // for missions
let achievements = [];
let missions = [
  {desc: "Deliver 3 flights", completed: false, target: 3},
  {desc: "Earn $100,000", completed: false}
];
let gameTime = { hours: 6, minutes: 0, day: 1 };

/* -------------------- Data -------------------- */
const allAirportsData = [
  {name:"JFK",lat:40.6413,lon:-73.7781},{name:"LAX",lat:33.9416,lon:-118.4085},{name:"ORD",lat:41.9742,lon:-87.9073},
  {name:"ATL",lat:33.6407,lon:-84.4277},{name:"DFW",lat:32.8998,lon:-97.0403},{name:"DEN",lat:39.8561,lon:-104.6737},
  {name:"SFO",lat:37.6213,lon:-122.3790},{name:"SEA",lat:47.4502,lon:-122.3088},{name:"MIA",lat:25.7959,lon:-80.2870},
  {name:"BOS",lat:42.3656,lon:-71.0096},{name:"PHX",lat:33.4373,lon:-112.0078},{name:"IAH",lat:29.9902,lon:-95.3368},
  {name:"MSP",lat:44.8848,lon:-93.2223},{name:"FLL",lat:26.0726,lon:-80.1527},{name:"DTW",lat:42.2162,lon:-83.3554},
  {name:"CLT",lat:35.2144,lon:-80.9431},{name:"PHL",lat:39.8754,lon:-75.2424},{name:"LGA",lat:40.7769,lon:-73.8740},
  {name:"MCO",lat:28.4312,lon:-81.3081},{name:"EWR",lat:40.6925,lon:-74.1687},{name:"SLC",lat:40.7884,lon:-111.9778},
  {name:"SAN",lat:32.7338,lon:-117.1933},{name:"PDX",lat:45.5898,lon:-122.5951},{name:"HOU",lat:29.6454,lon:-95.2789},
  {name:"BWI",lat:39.1754,lon:-76.6684},{name:"DCA",lat:38.8512,lon:-77.0402},{name:"TPA",lat:27.9755,lon:-82.5332},
  {name:"HNL",lat:21.3245,lon:-157.9251},{name:"OAK",lat:37.7126,lon:-122.2217},{name:"MSY",lat:29.9934,lon:-90.2580},
  {name:"MDW",lat:41.7858,lon:-87.7522},{name:"SJC",lat:37.3639,lon:-121.9289},{name:"RDU",lat:35.8776,lon:-78.7875},
  {name:"SMF",lat:38.6951,lon:-121.5910},{name:"PIT",lat:40.4958,lon:-80.2329},{name:"STL",lat:38.7471,lon:-90.3700},
  {name:"CLE",lat:41.4117,lon:-81.8493},{name:"SNA",lat:33.6757,lon:-117.8682},{name:"MCI",lat:39.2976,lon:-94.7139},
  {name:"IND",lat:39.7173,lon:-86.2944},{name:"BNA",lat:36.1245,lon:-86.6782},{name:"SFO2",lat:37.6188,lon:-122.375},
  {name:"JAX",lat:30.4941,lon:-81.6879},{name:"OAK2",lat:37.7126,lon:-122.2217},{name:"BUF",lat:42.9405,lon:-78.7322},
  {name:"SAT",lat:29.5337,lon:-98.4698},{name:"RIC",lat:37.5052,lon:-77.3199}
];

// airport objects
gameState.airports = allAirportsData.map((a,i)=>({
  name: a.name, lat: a.lat, lon: a.lon,
  level: 1, unlocked: i < 3,
  baseCost: 50000 + i*10000
}));

// plane tiers (upgrades)
const planeTypes = [
  {name:"Tiny Plane",   speed:0.5,  cost: 50000,  profitMultiplier:1},
  {name:"Regional Jet", speed:0.8,  cost:100000,  profitMultiplier:1.5},
  {name:"Boeing 737",   speed:1.0,  cost:200000,  profitMultiplier:2},
  {name:"Boeing 747",   speed:1.2,  cost:500000,  profitMultiplier:3}
];

/* -------------------- Map -------------------- */
const map = L.map('map').setView([39.5,-98.35], 4);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution:'&copy; OpenStreetMap contributors'
}).addTo(map);

function drawAirports(){
  gameState.airports.forEach(a=>{
    const color = a.unlocked ? "green" : "red";
    L.circleMarker([a.lat,a.lon], { color, radius: 8 })
      .addTo(map)
      .bindPopup(`${a.name} - Level ${a.level}${a.unlocked?"":" (Locked)"}<br>
                  Upgrade: $${Math.round(a.baseCost * 1.5 ** (a.level-1))}`);
  });
}

/* -------------------- Notifications -------------------- */
function notify(msg){
  const n = document.createElement('div');
  n.className = 'notification';
  n.textContent = msg;
  document.getElementById('notifications').appendChild(n);
  setTimeout(()=> n.remove(), 3000);
}

/* -------------------- UI -------------------- */
function updateUI(){
  document.getElementById('money').innerText = Math.round(gameState.money);

  // Airports list
  const airportDiv = document.getElementById('airportList');
  airportDiv.innerHTML = '';
  gameState.airports.forEach(a=>{
    const btn = document.createElement('button');
    if(a.unlocked){
      const cost = Math.round(a.baseCost * 1.5 ** (a.level-1));
      btn.textContent = `${a.name} (Lvl ${a.level}) Upgrade $${cost}`;
      btn.disabled = gameState.money < cost;
      btn.onclick = ()=> upgradeAirport(a);
    } else {
      btn.textContent = `Unlock ${a.name} $${a.baseCost}`;
      btn.disabled = gameState.money < a.baseCost;
      btn.onclick = ()=> unlockAirport(a);
    }
    airportDiv.appendChild(btn);
  });

  // Planes list
  const planeDiv = document.getElementById('planeList');
  planeDiv.innerHTML = '';
  gameState.planes.forEach((p,i)=>{
    const wrap = document.createElement('div');
    wrap.innerHTML = `
      ✈️ ${p.name} (${planeTypes[p.type].name}) - ${p.status}
      <button onclick="autoFlyPlane(${i})">Auto-Fly</button>
      <button onclick="upgradePlane(${i})">Upgrade</button><br>
      Queue: <input type="text" id="queue${i}" placeholder="Comma separated airports">
      <button onclick="assignQueue(${i})">Set Route</button>
    `;
    planeDiv.appendChild(wrap);
  });
}

/* -------------------- Airports actions -------------------- */
function unlockAirport(a){
  if(gameState.money >= a.baseCost){
    gameState.money -= a.baseCost;
    a.unlocked = true;
    notify(`${a.name} unlocked!`);
    updateUI();
  } else notify("Not enough money!");
}
function upgradeAirport(a){
  const cost = Math.round(a.baseCost * 1.5 ** (a.level-1));
  if(gameState.money >= cost){
    gameState.money -= cost;
    a.level++;
    notify(`${a.name} upgraded to level ${a.level}!`);
    updateUI();
  } else notify("Not enough money!");
}

/* -------------------- Planes -------------------- */
function buyPlane(){
  const type = 0; // start at Tiny Plane
  const cost = planeTypes[type].cost;
  if(gameState.money >= cost){
    gameState.money -= cost;
    const start = gameState.airports.find(a=>a.unlocked) || gameState.airports[0];
    const newPlane = {
      name: `Plane ${gameState.planes.length+1}`,
      type, status: "idle",
      lat: start.lat, lon: start.lon,
      queue: []
    };
    gameState.planes.push(newPlane);
    addPlaneMarker(newPlane);
    notify(`${newPlane.name} purchased!`);
    updateUI();
  } else notify("Not enough money!");
}

function upgradePlane(i){
  const plane = gameState.planes[i];
  if(plane.type >= planeTypes.length-1){
    notify(`${plane.name} is already at max level!`);
    return;
  }
  const next = plane.type + 1;
  const cost = planeTypes[next].cost;
  if(gameState.money >= cost){
    gameState.money -= cost;
    plane.type = next;
    notify(`${plane.name} upgraded to ${planeTypes[next].name}!`);
    updateUI();
  } else notify("Not enough money!");
}

function addPlaneMarker(p){
  planeMarkers[p.name] = L.marker([p.lat,p.lon], {
    icon: L.divIcon({ className:'plane-marker', html:'✈️' })
  }).addTo(map);
}

function autoFlyPlane(i){
  const plane = gameState.planes[i];
  const unlocked = gameState.airports.filter(a =>
    a.unlocked && (a.lat !== plane.lat || a.lon !== plane.lon)
  );
  if(unlocked.length === 0){ notify("No other airports unlocked!"); return; }
  const dest = unlocked[Math.floor(Math.random() * unlocked.length)];
  plane.queue = [dest.name];
  plane.status = "flying";
  setLegOrigin(plane);
  notify(`${plane.name} is flying to ${dest.name}`);
  drawFlightLines();
}

function assignQueue(i){
  const plane = gameState.planes[i];
  const raw = (document.getElementById(`queue${i}`).value || "");
  plane.queue = raw.split(",")
                   .map(s=>s.trim())
                   .filter(n=> gameState.airports.some(a=> a.name===n && a.unlocked));
  if(plane.queue.length > 0){
    plane.status = "flying";
    setLegOrigin(plane);
  }
  drawFlightLines();
  updateUI();
}

/* -------------------- Auto-Fly toggle -------------------- */
function toggleAutoFly(){
  autoFly = document.getElementById('autoFlyToggle').checked;
  const label = document.getElementById('autoFlyLabel');
  label.style.color = autoFly ? "green" : "red";
  if(autoFly){
    gameState.planes.forEach((p,i)=>{
      if(p.status === "idle") autoFlyPlane(i);
    });
  }
}

/* -------------------- Events / Missions / Achievements -------------------- */
const events = [
  {name:"Storm at JFK",  multiplier:0.8,  duration:20000, message:"Storm at JFK! Revenue -20%"},
  {name:"Holiday Season",multiplier:1.5,  duration:15000, message:"Holiday Season! Revenue +50%"}
];
function triggerRandomEvent(){
  const e = events[Math.floor(Math.random()*events.length)];
  currentEvent = e;
  notify(e.message);
  setTimeout(()=>{ currentEvent = null; notify(`${e.name} ended.`); }, e.duration);
}
setInterval(triggerRandomEvent, 60000);

function checkAchievements(){
  if(!achievements.includes("First Plane") && gameState.planes.length >= 1){
    achievements.push("First Plane");
    notify("Achievement Unlocked: First Plane!");
  }
  if(!achievements.includes("Money Master") && gameState.money >= 100000){
    achievements.push("Money Master");
    notify("Achievement Unlocked: Money Master!");
  }
  if(!achievements.includes("First Upgrade") && gameState.airports.some(a=>a.level>1)){
    achievements.push("First Upgrade");
    notify("Achievement Unlocked: First Upgrade!");
  }
}

function checkMissions(){
  missions.forEach(m=>{
    if(!m.completed){
      if(m.desc.includes("Deliver") && planeDeliveredCount >= (m.target||0)){
        m.completed = true;
        notify(`Mission Completed: ${m.desc}`);
      }
      if(m.desc.includes("Earn") && gameState.money >= 100000){
        m.completed = true;
        notify(`Mission Completed: ${m.desc}`);
      }
    }
  });
}

/* -------------------- Distance helpers (earnings) -------------------- */
function haversineKm(lat1, lon1, lat2, lon2){
  const R = 6371; // km
  const toRad = d => d * Math.PI/180;
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);
  const a = Math.sin(dLat/2)**2 +
            Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}
function nearestAirportName(lat, lon){
  let best = null, bestD = Infinity;
  gameState.airports.forEach(a=>{
    const d = Math.hypot(a.lat - lat, a.lon - lon);
    if(d < bestD){ bestD = d; best = a.name; }
  });
  return best || "Unknown";
}
function setLegOrigin(plane){
  plane._originLat = plane.lat;
  plane._originLon = plane.lon;
  plane._originName = nearestAirportName(plane.lat, plane.lon);
}

/* -------------------- Flight lines (visual queues) -------------------- */
function drawFlightLines(){
  // clear old
  Object.keys(flightLines).forEach(k=>{
    try{ map.removeLayer(flightLines[k]); }catch{}
  });
  flightLines = {};

  // draw new
  gameState.planes.forEach(p=>{
    if(p.queue.length > 0){
      const latlngs = [[p.lat,p.lon]];
      p.queue.forEach(name=>{
        const dest = gameState.airports.find(a=>a.name===name);
        if(dest) latlngs.push([dest.lat,dest.lon]);
      });
      flightLines[p.name] = L.polyline(latlngs, { color:'blue' }).addTo(map);
    }
  });
}

/* -------------------- Movement (constant step; distance = time) -------------------- */
function movePlanes(){
  gameState.planes.forEach(p=>{
    if(p.status === "flying" && p.queue.length > 0){
      const destName = p.queue[0];
      const dest = gameState.airports.find(a=>a.name===destName);
      if(!dest) return;

      const dx = dest.lat - p.lat;
      const dy = dest.lon - p.lon;
      const dist = Math.sqrt(dx*dx + dy*dy);

      if(dist < 0.01){
        // Arrived
        p.lat = dest.lat; p.lon = dest.lon;
        p.queue.shift();

        // ---- Distance-based earnings ----
        const originLat = p._originLat ?? p.lat;
        const originLon = p._originLon ?? p.lon;
        const originName = p._originName ?? nearestAirportName(originLat, originLon);
        const distanceKm = haversineKm(originLat, originLon, dest.lat, dest.lon);
        let category = "Short-haul";
        if(distanceKm >= 2000) category = "Long-haul";
        else if(distanceKm >= 500) category = "Medium-haul";
        const basePerKm = 1.2; // tweak for balance
        let mult = planeTypes[p.type].profitMultiplier * dest.level;
        if(currentEvent) mult *= (currentEvent.multiplier || 1);
        const profit = Math.round(distanceKm * basePerKm * mult) + 250;
        gameState.money += profit;
        notify(`${p.name} arrived: ${originName} → ${dest.name} — ${category}, ${distanceKm.toFixed(1)} km. Earned $${profit.toLocaleString()}`);
        planeDeliveredCount++;
        checkAchievements(); checkMissions();
        updateUI();

        // next leg / auto loop
        if(p.queue.length > 0){
          p.status = "flying";
          setLegOrigin(p);
        } else {
          p.status = "idle";
          if(autoFly){
            const options = gameState.airports.filter(a=> a.unlocked && (a.lat!==p.lat || a.lon!==p.lon));
            if(options.length){
              const next = options[Math.floor(Math.random() * options.length)];
              p.queue.push(next.name);
              p.status = "flying";
              setLegOrigin(p);
              notify(`${p.name} is flying to ${next.name}`);
            }
          }
        }
      } else {
        // constant step length -> time scales with distance
        const stepLen = planeTypes[p.type].speed * 0.006; // adjust feel here
        const nx = dx / dist, ny = dy / dist;
        if(stepLen >= dist){
          p.lat = dest.lat; p.lon = dest.lon;
        } else {
          p.lat += nx * stepLen;
          p.lon += ny * stepLen;
        }
      }

      // update marker
      if(planeMarkers[p.name]) planeMarkers[p.name].setLatLng([p.lat,p.lon]);
    }
  });

  drawFlightLines();
}

/* -------------------- Passive Income -------------------- */
function addPassiveIncome(){
  let income = 0;
  gameState.airports.forEach(a=>{ if(a.unlocked) income += 100 * a.level; });
  gameState.money += income;
  if(income > 0) notify(`Passive income: $${income}`);
  updateUI();
}

/* -------------------- Game Time -------------------- */
function updateTime(){
  gameTime.minutes += 10;                 // 10 minutes per real second
  if(gameTime.minutes >= 60){ gameTime.minutes = 0; gameTime.hours++; }
  if(gameTime.hours >= 24){ gameTime.hours = 0; gameTime.day++; notify(`Day ${gameTime.day} has started!`); }
  document.getElementById('gameTime').innerText =
    `${String(gameTime.hours).padStart(2,'0')}:${String(gameTime.minutes).padStart(2,'0')}`;
  document.getElementById('gameDay').innerText = gameTime.day;
}

/* -------------------- Profit Chart -------------------- */
const chartCtx = document.getElementById('profitChart').getContext('2d');
const profitData = {
  labels: [0],
  datasets: [{ label: 'Money', data: [gameState.money], tension: 0.2 }]
};
const profitChart = new Chart(chartCtx, {
  type: 'line',
  data: profitData,
  options: {
    responsive: true,
    plugins: { legend: { display: true } },
    scales: {
      x: { title: { display: true, text: 'Game Time (minutes)' } },
      y: { title: { display: true, text: 'Money ($)' } }
    }
  }
});
function updateChart(){
  const last = profitData.labels[profitData.labels.length-1] || 0;
  profitData.labels.push(last + 10); // 10-minute ticks
  profitData.datasets[0].data.push(gameState.money);
  if(profitData.labels.length > 50){ profitData.labels.shift(); profitData.datasets[0].data.shift(); }
  profitChart.update();
}

/* -------------------- Init -------------------- */
drawAirports();
updateUI();
setInterval(movePlanes, 50);        // movement
setInterval(addPassiveIncome, 10000); // passive income every 10s
setInterval(updateTime, 1000);      // 1s = 10 game minutes
setInterval(updateChart, 10000);    // sync with passive income ticks
</script>
</body>
</html>
