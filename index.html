<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Airplane Tycoon</title>
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
    body, html { margin:0; padding:0; font-family: sans-serif; height: 100%; }
    #map { width: 100%; height: 70%; }
    #ui { padding: 10px; background: #f0f0f0; height: 30%; overflow-y: auto; }
    .section { margin-bottom: 10px; }
    button { margin: 2px; }
    .notification { 
        position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
        background: rgba(0,0,0,0.7); color: white; padding: 5px 10px; border-radius: 5px;
        display: none;
        z-index: 1000;
    }
    .plane-icon { width: 32px; height: 32px; }
</style>
</head>
<body>

<div id="map"></div>
<div id="ui">
    <div class="section">Money: $<span id="money">0</span></div>
    <div class="section" id="airportsList"></div>
    <div class="section" id="planesList"></div>
    <div class="section"><button onclick="restartGame()">Restart Game</button></div>
</div>
<div id="notification" class="notification"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
// ====== GAME DATA ======
const airportsData = [
    { code: 'JFK', name: 'John F. Kennedy Intl', lat: 40.6413, lon: -73.7781 },
    { code: 'LHR', name: 'London Heathrow', lat: 51.4700, lon: -0.4543 },
    { code: 'CDG', name: 'Paris Charles de Gaulle', lat: 49.0097, lon: 2.5479 },
    { code: 'HND', name: 'Tokyo Haneda', lat: 35.5494, lon: 139.7798 },
    { code: 'SYD', name: 'Sydney Airport', lat: -33.9399, lon: 151.1753 },
    { code: 'DXB', name: 'Dubai Intl', lat: 25.2532, lon: 55.3657 },
    { code: 'LAX', name: 'Los Angeles Intl', lat: 33.9416, lon: -118.4085 },
    { code: 'FRA', name: 'Frankfurt Intl', lat: 50.0379, lon: 8.5622 },
    // Add more airports up to 30
];
let gameData = {
    money: 100000,
    unlockedAirports: ['JFK','LHR','CDG'],
    planes: [
        { id:1, type:'Tiny Plane', location:'JFK', destination:null, status:'idle', earnings:0, rating:100 }
    ],
    planeIdCounter: 2
};

// Plane definitions
const planeTypes = [
    { name:'Tiny Plane', cost:50000, speed:0.5, capacity:50, earningsMultiplier:1 },
    { name:'Regional Jet', cost:200000, speed:1, capacity:100, earningsMultiplier:2 },
    { name:'Boeing 737', cost:500000, speed:1.5, capacity:200, earningsMultiplier:3 },
    { name:'Boeing 747', cost:1000000, speed:2, capacity:400, earningsMultiplier:5 }
];

// ====== MAP ======
const map = L.map('map').setView([20,0], 2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18
}).addTo(map);

let airportMarkers = {};
function updateAirports() {
    for(let code in airportMarkers) {
        map.removeLayer(airportMarkers[code]);
    }
    airportMarkers = {};
    gameData.unlockedAirports.forEach(code => {
        const airport = airportsData.find(a=>a.code===code);
        const marker = L.marker([airport.lat, airport.lon]).addTo(map)
            .bindPopup(`${airport.name} (${airport.code})`);
        airportMarkers[code] = marker;
    });
}
updateAirports();

// ====== UI ======
function updateUI() {
    document.getElementById('money').innerText = Math.floor(gameData.money);

    // Airports
    const airportsDiv = document.getElementById('airportsList');
    airportsDiv.innerHTML = '<b>Airports:</b> ' + gameData.unlockedAirports.join(', ');

    // Planes
    const planesDiv = document.getElementById('planesList');
    planesDiv.innerHTML = '<b>Planes:</b><br>';
    gameData.planes.forEach(plane=>{
        planesDiv.innerHTML += `
            ${plane.type} (Location: ${plane.location}) 
            <button onclick="assignRoute(${plane.id})">Fly</button> 
            <button onclick="autoFly(${plane.id})">Auto</button>
            <button onclick="upgradePlane(${plane.id})">Upgrade</button>
            <br>`;
    });
}
updateUI();

// ====== NOTIFICATIONS ======
function notify(msg, duration=2000){
    const notif = document.getElementById('notification');
    notif.innerText = msg;
    notif.style.display='block';
    setTimeout(()=>notif.style.display='none', duration);
}

// ====== GAME FUNCTIONS ======
function saveGame() {
    localStorage.setItem('airplaneTycoonSave', JSON.stringify(gameData));
}
function loadGame() {
    const saved = localStorage.getItem('airplaneTycoonSave');
    if(saved) gameData = JSON.parse(saved);
}
function restartGame(){
    if(confirm('Are you sure? Restart game will lose progress.')){
        localStorage.removeItem('airplaneTycoonSave');
        location.reload();
    }
}

// Upgrade plane
function upgradePlane(id){
    const plane = gameData.planes.find(p=>p.id===id);
    const currentIndex = planeTypes.findIndex(pt=>pt.name===plane.type);
    if(currentIndex < planeTypes.length-1){
        const nextPlane = planeTypes[currentIndex+1];
        if(gameData.money >= nextPlane.cost){
            gameData.money -= nextPlane.cost;
            plane.type = nextPlane.name;
            notify(`Upgraded to ${nextPlane.name}`);
        }else{
            notify('Not enough money');
        }
    }else{
        notify('Plane is at max level');
    }
    updateUI();
}

// Assign flight route manually
function assignRoute(id){
    const plane = gameData.planes.find(p=>p.id===id);
    const dest = prompt('Enter destination airport code:');
    if(gameData.unlockedAirports.includes(dest) && dest!==plane.location){
        plane.destination = dest;
        plane.status = 'flying';
        flyPlane(plane);
        notify(`${plane.type} flying to ${dest}`);
    }else{
        notify('Invalid destination');
    }
}

// Auto fly to random airport
function autoFly(id){
    const plane = gameData.planes.find(p=>p.id===id);
    const possible = gameData.unlockedAirports.filter(a=>a!==plane.location);
    if(possible.length>0){
        plane.destination = possible[Math.floor(Math.random()*possible.length)];
        plane.status = 'flying';
        flyPlane(plane);
        notify(`${plane.type} auto flying to ${plane.destination}`);
    }
}

// Simulate flight
function flyPlane(plane){
    const startAirport = airportsData.find(a=>a.code===plane.location);
    const endAirport = airportsData.find(a=>a.code===plane.destination);
    if(!startAirport || !endAirport) return;

    const planeIcon = L.icon({
        iconUrl: 'https://cdn-icons-png.flaticon.com/512/69/69407.png',
        iconSize: [32,32]
    });
    const marker = L.marker([startAirport.lat,startAirport.lon],{icon:planeIcon}).addTo(map);

    const steps = 50;
    let step = 0;
    const latStep = (endAirport.lat - startAirport.lat)/steps;
    const lonStep = (endAirport.lon - startAirport.lon)/steps;
    const interval = setInterval(()=>{
        step++;
        marker.setLatLng([startAirport.lat + latStep*step, startAirport.lon + lonStep*step]);
        if(step>=steps){
            clearInterval(interval);
            map.removeLayer(marker);
            plane.location = plane.destination;
            plane.destination = null;
            plane.status = 'idle';
            const earnings = calculateEarnings(plane,startAirport,endAirport);
            gameData.money += earnings;
            plane.rating -= 1;
            notify(`Flight completed! Earned $${Math.floor(earnings)}`);
            updateUI();
            saveGame();
        }
    }, 1000/planeTypes.find(pt=>pt.name===plane.type).speed);
}

// Earnings calculation
function calculateEarnings(plane,start,end){
    const distance = getDistance(start.lat,start.lon,end.lat,end.lon);
    const planeData = planeTypes.find(pt=>pt.name===plane.type);
    return distance * 10 * planeData.earningsMultiplier * plane.rating/100;
}

// Haversine distance
function getDistance(lat1, lon1, lat2, lon2) {
    function toRad(x){return x*Math.PI/180;}
    const R = 6371;
    const dLat = toRad(lat2-lat1);
    const dLon = toRad(lon2-lon1);
    const a = Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)*Math.sin(dLon/2);
    const c = 2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R*c;
}

// Passive income
setInterval(()=>{
    gameData.money += 100;
    updateUI();
    saveGame();
}, 5000);

// Auto load game
loadGame();
updateUI();
updateAirports();

</script>
</body>
</html>
