<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Airplane Tycoon Full</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
html, body { height:100%; margin:0; font-family:Arial,sans-serif; }
#map { height:50%; }
#ui { padding:10px; }
button { margin:2px; }
#notifications { position: fixed; bottom:10px; right:10px; width:300px; }
.notification { background:#333; color:#fff; padding:5px 10px; margin-top:5px; border-radius:5px; opacity:0.9; }
</style>
</head>
<body>

<div id="map"></div>
<div id="ui">
  <h2 id="companyNameDisplay">Airplane Tycoon</h2>
  <div id="timeDisplay"></div>
  <div>Money: $<span id="money">0</span></div>
  <button onclick="buyPlane()">Buy Plane ($50,000)</button>
  <button onclick="restartGame()">Restart Game</button>
  <label><input type="checkbox" id="autoFlyToggle" onchange="toggleAutoFly()"> Auto-Fly</label>

  <h3>Airports</h3>
  <div id="airportList"></div>
  
  <h3>Planes</h3>
  <div id="planeList"></div>
</div>
<div id="notifications"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
// --- GAME STATE ---
let gameState = {
    companyName:"",
    money:150000,
    airports:[],
    planes:[],
    time:{day:1,hour:6,minute:0}
};
let autoFly=false;
let planeMarkers={};
let activeEvents = [];
let activeMissions = [];
let achievements = [
    {text:"Own 5 planes", type:"planes", target:5, reward:20000, completed:false},
    {text:"Reach $1,000,000", type:"money", target:1000000, reward:50000, completed:false},
    {text:"Upgrade an airport to level 5", type:"airportLevel", target:5, reward:30000, completed:false}
];

// --- INITIAL AIRPORTS ---
const airportData=[
    {name:"JFK",lat:40.6413,lon:-73.7781},{name:"LAX",lat:33.9416,lon:-118.4085},{name:"ORD",lat:41.9742,lon:-87.9073}
];
airportData.forEach(a=>{
    gameState.airports.push({name:a.name,lat:a.lat,lon:a.lon,level:1,unlocked:true,baseCost:50000});
});

// --- MAP ---
const map = L.map('map').setView([39.5,-98.35],4);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap contributors'}).addTo(map);

// --- PLANE TYPES ---
const planeTypes=[{name:"Tiny Plane",speed:500,cost:50000,profitMultiplier:1}];

// --- NOTIFICATIONS ---
function notify(msg){
    const n=document.createElement('div');
    n.className="notification";
    n.innerText=msg;
    document.getElementById("notifications").appendChild(n);
    setTimeout(()=>n.remove(),3000);
}

// --- COMPANY NAME ---
function askCompanyName(){
    const name = prompt("Enter your airline company name:");
    gameState.companyName = name || "Airplane Tycoon";
    document.getElementById('companyNameDisplay').innerText = gameState.companyName;
}
askCompanyName();

// --- SAVE/LOAD ---
function saveGame(){localStorage.setItem("airplaneTycoonFull",JSON.stringify(gameState));}
function loadGame(){const saved = localStorage.getItem("airplaneTycoonFull"); if(saved) gameState=JSON.parse(saved);}
loadGame();

// --- UI UPDATE ---
function updateUI(){
    document.getElementById('money').innerText = Math.round(gameState.money);

    const airportDiv=document.getElementById('airportList');
    airportDiv.innerHTML='';
    gameState.airports.forEach(a=>{
        const btn=document.createElement('button');
        btn.innerText=`${a.name} (Lvl ${a.level}) Upgrade $${Math.round(a.baseCost*1.5**(a.level-1))}`;
        btn.disabled=gameState.money<a.baseCost*1.5**(a.level-1);
        btn.onclick=()=>upgradeAirport(a);
        airportDiv.appendChild(btn);
    });

    const planeDiv=document.getElementById('planeList');
    planeDiv.innerHTML='';
    gameState.planes.forEach((p,i)=>{
        const div=document.createElement('div');
        div.innerHTML=`✈️ ${p.name} - ${p.status} 
            <button onclick="autoFlyPlane(${i})">Auto-Fly</button>`;
        planeDiv.appendChild(div);
    });
}

// --- AIRPORT FUNCTIONS ---
function upgradeAirport(a){
    const cost = Math.round(a.baseCost*1.5**(a.level-1));
    if(gameState.money>=cost){
        gameState.money-=cost;
        a.level++;
        notify(`${a.name} upgraded to level ${a.level}!`);
        checkMissions("upgrade", a.name);
        checkAchievements();
        updateUI();
        saveGame();
    } else notify("Not enough money to upgrade!");
}

// --- PLANE FUNCTIONS ---
function buyPlane(){
    const type = 0;
    const cost = planeTypes[type].cost;
    if(gameState.money>=cost){
        gameState.money-=cost;
        const newPlane = {name:`Plane ${gameState.planes.length+1}`, type:type, status:"idle", lat:gameState.airports[0].lat, lon:gameState.airports[0].lon, queue:[]};
        gameState.planes.push(newPlane);
        notify(`${newPlane.name} purchased!`);
        updateUI();
        addPlaneMarker(newPlane);
        checkAchievements();
        saveGame();
    } else notify("Not enough money!");
}

// --- AUTO FLY ---
function autoFlyPlane(i){
    const plane = gameState.planes[i];
    const unlocked = gameState.airports.filter(a=>a.unlocked&&(a.lat!==plane.lat||a.lon!==plane.lon));
    if(unlocked.length===0){ notify("No other airports unlocked!"); return; }
    const dest = unlocked[Math.floor(Math.random()*unlocked.length)];
    plane.queue = [dest.name];
    plane.status="flying";
    notify(`${plane.name} is flying to ${dest.name}`);
    updateUI();
    saveGame();
}

// --- TOGGLE ---
function toggleAutoFly(){autoFly=document.getElementById("autoFlyToggle").checked;}

// --- RESTART ---
function restartGame(){if(confirm("Restart game?")){localStorage.clear();location.reload();}}

// --- EVENTS SYSTEM ---
const eventTypes = [
    { name: "Storm", effect: (plane, airport)=>0.8, description: "Storm at airport reduces revenue!" },
    { name: "Holiday", effect: (plane, airport)=>1.2, description: "Holiday season! Revenue increased!" }
];

function triggerRandomEvent(){
    const event = eventTypes[Math.floor(Math.random()*eventTypes.length)];
    if(event.name==="Storm"){
        const airport = gameState.airports[Math.floor(Math.random()*gameState.airports.length)];
        activeEvents.push({type:event,airport:airport,duration:6});
        notify(`Event: ${event.name} at ${airport.name}! ${event.description}`);
    } else {
        activeEvents.push({type:event,duration:12});
        notify(`Event: ${event.name}! ${event.description}`);
    }
}

function updateEvents(){
    activeEvents.forEach(ev=>ev.duration-=1);
    activeEvents = activeEvents.filter(ev=>ev.duration>0);
}

function calculateProfit(plane, airport){
    let baseProfit = 1000*planeTypes[plane.type].profitMultiplier*airport.level;
    let multiplier = 1;
    activeEvents.forEach(ev=>{
        if(ev.type.name==="Storm" && ev.airport.name===airport.name) multiplier *= ev.type.effect(plane, airport);
        if(ev.type.name==="Holiday") multiplier *= ev.type.effect(plane, airport);
    });
    return baseProfit * multiplier;
}

// --- MISSIONS SYSTEM ---
const missionTemplates = [
    {text: "Fly 3 planes to JFK", type: "fly", target: "JFK", required: 3, reward: 5000},
    {text: "Upgrade 2 airports", type: "upgrade", required: 2, reward: 10000}
];

function generateMissions(){
    activeMissions = missionTemplates.map(m => ({...m, progress:0, completed:false}));
    updateMissionUI();
}

function updateMissionUI(){
    let missionDiv = document.getElementById("missionList");
    if(!missionDiv){
        missionDiv = document.createElement("div");
        missionDiv.id = "missionList";
        document.getElementById("ui").appendChild(missionDiv);
    }
    missionDiv.innerHTML = "<h3>Missions</h3>";
    activeMissions.forEach(m=>{
        const div = document.createElement("div");
        div.innerText = `${m.text} - ${m.progress}/${m.required} ${m.completed?"✅":"❌"}`;
        missionDiv.appendChild(div);
    });
}

function checkMissions(eventType, airportName){
    activeMissions.forEach(m=>{
        if(m.completed) return;
        if(m.type === eventType){
            if(eventType==="fly" && m.target === airportName) m.progress++;
            if(eventType==="upgrade") m.progress++;
            if(m.progress >= m.required){
                m.completed = true;
                gameState.money += m.reward;
                notify(`Mission completed: ${m.text}! Earned $${m.reward}`);
            }
        }
    });
    updateMissionUI();
}

// --- ACHIEVEMENTS SYSTEM ---
function updateAchievementsUI(){
    let achDiv = document.getElementById("achievementList");
    if(!achDiv){
        achDiv = document.createElement("div");
        achDiv.id = "achievementList";
        document.getElementById("ui").appendChild(achDiv);
    }
    achDiv.innerHTML = "<h3>Achievements</h3>";
    achievements.forEach(a=>{
        const div = document.createElement("div");
        div.innerText = `${a.text} ${a.completed?"✅":"❌"}`;
        achDiv.appendChild(div);
    });
}

function checkAchievements(){
    achievements.forEach(a=>{
        if(a.completed) return;
        if(a.type==="planes" && gameState.planes.length>=a.target) a.completed=true;
        if(a.type==="money" && gameState.money>=a.target) a.completed=true;
        if(a.type==="airportLevel" && gameState.airports.some(ap=>ap.level>=a.target)) a.completed=true;
        if(a.completed){
            gameState.money += a.reward;
            notify(`Achievement unlocked: ${a.text}! Earned $${a.reward}`);
        }
    });
    updateAchievementsUI();
}

// --- PLANE MARKERS & MOVEMENT ---
function addPlaneMarker(p){
    planeMarkers[p.name]=L.marker([p.lat,p.lon], {icon:L.divIcon({className:'plane-marker', html:'✈️'})}).addTo(map);
}

function movePlanesWithMissions(){
    gameState.planes.forEach(p=>{
        if(p.status==="flying" && p.queue.length>0){
            const destName = p.queue[0];
            const dest = gameState.airports.find(a=>a.name===destName);
            if(!dest) return;
            const dx = dest.lat - p.lat;
            const dy = dest.lon - p.lon;
            const dist = Math.sqrt(dx*dx + dy*dy);
            const speed = planeTypes[p.type].speed/1000;
            if(dist<0.01){
                p.lat=dest.lat; p.lon=dest.lon;
                p.status="idle";
                p.queue.shift();
                const profit = Math.round(calculateProfit(p, dest));
                gameState.money += profit;
                notify(`${p.name} arrived at ${dest.name}! Earned $${profit}`);
                checkMissions("fly", dest.name);
                checkAchievements();
            } else {
                p.lat += dx*speed;
                p.lon += dy*speed;
            }
            planeMarkers[p.name].setLatLng([p.lat,p.lon]);
        }
    });
}

// --- GAME TIME ---
function advanceTime(){
    gameState.time.minute+=10;
    if(gameState.time.minute>=60){ gameState.time.minute=0; gameState.time.hour++; }
    if(gameState.time.hour>=24){ 
        gameState.time.hour=0; gameState.time.day++; 
        generateMissions();
    }
    document.getElementById('timeDisplay').innerText=`Day ${gameState.time.day}, ${gameState.time.hour.toString().padStart(2,'0')}:${gameState.time.minute.toString().padStart(2,'0')}`;
}

// --- INTERVALS ---
setInterval(movePlanesWithMissions,1000);
setInterval(()=>{
    advanceTime();
    updateEvents();
    if(Math.random()<0.05) triggerRandomEvent();
    saveGame();
},1000);

// --- INITIAL MARKERS & UI ---
gameState.planes.forEach(addPlaneMarker);
updateUI();
generateMissions();
updateAchievementsUI();
</script>
</body>
</html>
