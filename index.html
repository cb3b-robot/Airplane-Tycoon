<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Airplane Tycoon</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
html, body { height:100%; margin:0; font-family:Arial,sans-serif; }
#map { height:50%; }
#ui { padding:10px; }
button { margin:2px; }
#notifications { position: fixed; bottom:10px; right:10px; width:300px; z-index:999; }
.notification { background:#333; color:#fff; padding:5px 10px; margin-top:5px; border-radius:5px; opacity:0.9; }
.plane-marker { font-size:18px; }
</style>
</head>
<body>

<div id="map"></div>
<div id="ui">
  <h2 id="companyNameDisplay">Airplane Tycoon</h2>
  <div>Money: $<span id="money">150000</span></div>
  <div>Time: <span id="gameTime">06:00</span> | Day: <span id="gameDay">1</span></div>
  <button onclick="buyPlane()">Buy Plane ($50,000)</button>
  <label>
    <input type="checkbox" id="autoFlyToggle" onchange="toggleAutoFly()"> Auto-Fly
  </label>

  <h3>Airports</h3>
  <div id="airportList"></div>
  
  <h3>Planes</h3>
  <div id="planeList"></div>
  
  <h3>Profit Chart</h3>
  <canvas id="profitChart" width="400" height="200"></canvas>
</div>
<div id="notifications"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
// --- Game State ---
let gameState = {
    companyName: "Airplane Tycoon",
    money: 150000,
    airports: [],
    planes: []
};
let autoFly=false;
let planeMarkers={};
let planeDeliveredCount=0;
let currentEvent=null;
let achievements=[];
let missions=[
    {desc:"Deliver 3 flights", completed: false, counter:0, target:3},
    {desc:"Earn $100,000", completed:false}
];
let gameTime = { hours: 6, minutes: 0, day: 1 };
let flightLines = {};
let profitHistory = [];

// --- Airport Data (50+) ---
const allAirportsData = [
    {name:"JFK",lat:40.6413,lon:-73.7781},{name:"LAX",lat:33.9416,lon:-118.4085},{name:"ORD",lat:41.9742,lon:-87.9073},
    {name:"ATL",lat:33.6407,lon:-84.4277},{name:"DFW",lat:32.8998,lon:-97.0403},{name:"DEN",lat:39.8561,lon:-104.6737},
    {name:"SFO",lat:37.6213,lon:-122.3790},{name:"SEA",lat:47.4502,lon:-122.3088},{name:"MIA",lat:25.7959,lon:-80.2870},
    {name:"BOS",lat:42.3656,lon:-71.0096},{name:"PHX",lat:33.4373,lon:-112.0078},{name:"IAH",lat:29.9902,lon:-95.3368},
    {name:"MSP",lat:44.8848,lon:-93.2223},{name:"FLL",lat:26.0726,lon:-80.1527},{name:"DTW",lat:42.2162,lon:-83.3554},
    {name:"CLT",lat:35.2144,lon:-80.9431},{name:"PHL",lat:39.8754,lon:-75.2424},{name:"LGA",lat:40.7769,lon:-73.8740},
    {name:"MCO",lat:28.4312,lon:-81.3081},{name:"EWR",lat:40.6925,lon:-74.1687},{name:"SLC",lat:40.7884,lon:-111.9778},
    {name:"SAN",lat:32.7338,lon:-117.1933},{name:"PDX",lat:45.5898,lon:-122.5951},{name:"HOU",lat:29.6454,lon:-95.2789},
    {name:"BWI",lat:39.1754,lon:-76.6684},{name:"DCA",lat:38.8512,lon:-77.0402},{name:"TPA",lat:27.9755,lon:-82.5332},
    {name:"HNL",lat:21.3245,lon:-157.9251},{name:"OAK",lat:37.7126,lon:-122.2217},{name:"MSY",lat:29.9934,lon:-90.2580},
    {name:"MDW",lat:41.7858,lon:-87.7522},{name:"SJC",lat:37.3639,lon:-121.9289},{name:"RDU",lat:35.8776,lon:-78.7875},
    {name:"SMF",lat:38.6951,lon:-121.5910},{name:"PIT",lat:40.4958,lon:-80.2329},{name:"STL",lat:38.7471,lon:-90.3700},
    {name:"CLE",lat:41.4117,lon:-81.8493},{name:"SNA",lat:33.6757,lon:-117.8682},{name:"MCI",lat:39.2976,lon:-94.7139},
    {name:"IND",lat:39.7173,lon:-86.2944},{name:"BNA",lat:36.1245,lon:-86.6782},{name:"SFO2",lat:37.6188,lon:-122.375},
    {name:"JAX",lat:30.4941,lon:-81.6879},{name:"OAK2",lat:37.7126,lon:-122.2217},{name:"BUF",lat:42.9405,lon:-78.7322},
    {name:"SAT",lat:29.5337,lon:-98.4698},{name:"RIC",lat:37.5052,lon:-77.3199}
];

// --- Initialize Airports ---
gameState.airports = allAirportsData.map((a,i)=>({
    name: a.name,
    lat: a.lat,
    lon: a.lon,
    level:1,
    unlocked: i<3,
    baseCost: 50000 + i*10000
}));

// --- Map ---
const map = L.map('map').setView([39.5,-98.35],4);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    attribution:'&copy; OpenStreetMap contributors'
}).addTo(map);

// --- Plane Types / Upgrades ---
const planeTypes = [
    {name:"Tiny Plane", speed:0.5, cost:50000, profitMultiplier:1},
    {name:"Regional Jet", speed:0.8, cost:100000, profitMultiplier:1.5},
    {name:"Boeing 737", speed:1, cost:200000, profitMultiplier:2},
    {name:"Boeing 747", speed:1.2, cost:500000, profitMultiplier:3}
];

// --- Events ---
const events=[
    {name:"Storm at JFK", multiplier:0.8, duration:20000, message:"Storm at JFK! Revenue -20%"},
    {name:"Holiday Season", multiplier:1.5, duration:15000, message:"Holiday Season! Revenue +50%"}
];
function triggerRandomEvent(){
    const e = events[Math.floor(Math.random()*events.length)];
    currentEvent=e;
    notify(e.message);
    setTimeout(()=>{ currentEvent=null; notify(`${e.name} ended.`); }, e.duration);
}
setInterval(triggerRandomEvent,60000);

// --- Notifications ---
function notify(msg){
    const n=document.createElement('div');
    n.className="notification";
    n.innerText=msg;
    document.getElementById("notifications").appendChild(n);
    setTimeout(()=>n.remove(),3000);
}

// --- Airports UI ---
function drawAirports(){
    gameState.airports.forEach(a=>{
        const color = a.unlocked ? "green" : "red";
        L.circleMarker([a.lat,a.lon], {color: color, radius:8})
          .addTo(map)
          .bindPopup(`${a.name} - Level ${a.level}${a.unlocked?"":" (Locked)"}<br>Upgrade: $${Math.round(a.baseCost*1.5**(a.level-1))}`);
    });
}

function updateUI(){
    document.getElementById("money").innerText = Math.round(gameState.money);
    
    const airportDiv=document.getElementById('airportList');
    airportDiv.innerHTML='';
    gameState.airports.forEach(a=>{
        const btn=document.createElement('button');
        if(a.unlocked){
            btn.innerText=`${a.name} (Lvl ${a.level}) Upgrade $${Math.round(a.baseCost*1.5**(a.level-1))}`;
            btn.disabled = gameState.money < a.baseCost*1.5**(a.level-1);
            btn.onclick = ()=>{ upgradeAirport(a); };
        } else {
            btn.innerText=`Unlock ${a.name} $${a.baseCost}`;
            btn.disabled = gameState.money < a.baseCost;
            btn.onclick = ()=>{ unlockAirport(a); };
        }
        airportDiv.appendChild(btn);
    });

    const planeDiv=document.getElementById('planeList');
    planeDiv.innerHTML='';
    gameState.planes.forEach((p,i)=>{
        const div=document.createElement('div');
        div.innerHTML=`✈️ ${p.name} (${planeTypes[p.type].name}) - ${p.status} 
            <button onclick="autoFlyPlane(${i})">Auto-Fly</button>
            <button onclick="upgradePlane(${i})">Upgrade</button>
            <br>Queue: <input type="text" id="queue${i}" placeholder="Comma separated airports">
            <button onclick="assignQueue(${i})">Set Route</button>`;
        planeDiv.appendChild(div);
    });
}

// --- Airports ---
function upgradeAirport(a){
    const cost = Math.round(a.baseCost*1.5**(a.level-1));
    if(gameState.money>=cost){
        gameState.money-=cost;
        a.level++;
        notify(`${a.name} upgraded to level ${a.level}!`);
        updateUI();
    } else notify("Not enough money!");
}
function unlockAirport(a){
    if(gameState.money>=a.baseCost){
        gameState.money-=a.baseCost;
        a.unlocked=true;
        notify(`${a.name} unlocked!`);
        updateUI();
    } else notify("Not enough money!");
}

// --- Planes ---
function buyPlane(){
    const type = 0;
    const cost = planeTypes[type].cost;
    if(gameState.money>=cost){
        gameState.money-=cost;
        const newPlane = {name:`Plane ${gameState.planes.length+1}`, type:type, status:"idle", lat:gameState.airports[0].lat, lon:gameState.airports[0].lon, queue:[]};
        gameState.planes.push(newPlane);
        notify(`${newPlane.name} purchased!`);
        addPlaneMarker(newPlane);
        updateUI();
    } else notify("Not enough money!");
}

function upgradePlane(i){
    const plane = gameState.planes[i];
    const currentType = plane.type;
    if(currentType >= planeTypes.length-1){
        notify(`${plane.name} is already at max level!`);
        return;
    }
    const nextType = currentType + 1;
    const cost = planeTypes[nextType].cost;
    if(gameState.money >= cost){
        gameState.money -= cost;
        plane.type = nextType;
        notify(`${plane.name} upgraded to ${planeTypes[nextType].name}!`);
        updateUI();
    } else notify("Not enough money!");
}

function addPlaneMarker(p){
    planeMarkers[p.name]=L.marker([p.lat,p.lon], {icon:L.divIcon({className:'plane-marker', html:'✈️'})}).addTo(map);
}

function autoFlyPlane(i){
    const plane = gameState.planes[i];
    const unlocked = gameState.airports.filter(a=>a.unlocked&&(a.lat!==plane.lat||a.lon!==plane.lon));
    if(unlocked.length===0){ notify("No other airports unlocked!"); return; }
    const dest = unlocked[Math.floor(Math.random()*unlocked.length)];
    plane.queue=[dest.name];
    plane.status="flying";
    notify(`${plane.name} is flying to ${dest.name}`);
}

function assignQueue(i){
    const val = document.getElementById(`queue${i}`).value;
    const plane = gameState.planes[i];
    plane.queue = val.split(",").map(s=>s.trim()).filter(name=>gameState.airports.some(a=>a.name===name && a.unlocked));
    if(plane.queue.length>0) plane.status="flying";
    updateUI();
    drawFlightLines();
}

// --- Auto-Fly Toggle ---
function toggleAutoFly(){
    autoFly = document.getElementById("autoFlyToggle").checked;
    const label = document.getElementById("autoFlyToggle").parentElement;
    label.style.color = autoFly ? "green" : "red";
    if(autoFly){
        gameState.planes.forEach((p,i)=>{
            if(p.status==="idle") autoFlyPlane(i);
        });
    }
}

// --- Achievements & Missions ---
function checkAchievements(){
    if(!achievements.includes("First Plane") && gameState.planes.length>=1){
        achievements.push("First Plane");
        notify("Achievement Unlocked: First Plane!");
    }
    if(!achievements.includes("Money Master") && gameState.money>=100000){
        achievements.push("Money Master");
        notify("Achievement Unlocked: Money Master!");
    }
    if(!achievements.includes("First Upgrade") && gameState.airports.some(a=>a.level>1)){
        achievements.push("First Upgrade");
        notify("Achievement Unlocked: First Upgrade!");
    }
}

function checkMissions(){
    missions.forEach(m=>{
        if(!m.completed){
            if(m.desc.includes("Deliver") && planeDeliveredCount>=m.target){
                m.completed=true;
                notify(`Mission Completed: ${m.desc}`);
            }
            if(m.desc.includes("Earn") && gameState.money>=100000){
                m.completed=true;
                notify(`Mission Completed: ${m.desc}`);
            }
        }
    });
}

// --- Flight Lines ---
function drawFlightLines(){
    Object.keys(flightLines).forEach(k => { map.removeLayer(flightLines[k]); });
    flightLines = {};
    gameState.planes.forEach(p=>{
        if(p.queue.length>0){
            const latlngs = [[p.lat,p.lon]];
            p.queue.forEach(destName => {
                const dest = gameState.airports.find(a=>a.name===destName);
                if(dest) latlngs.push([dest.lat,dest.lon]);
            });
            flightLines[p.name] = L.polyline(latlngs,{color:'blue'}).addTo(map);
        }
    });
}

// --- Move Planes ---
function movePlanes(){
    gameState.planes.forEach(p=>{
        if(p.status==="flying" && p.queue.length>0){
            const destName=p.queue[0];
            const dest = gameState.airports.find(a=>a.name===destName);
            if(!dest) return;

            const dx = dest.lat - p.lat;
            const dy = dest.lon - p.lon;
            const dist = Math.sqrt(dx*dx + dy*dy);

            if(dist < 0.01){
                p.lat = dest.lat; p.lon = dest.lon;
                p.queue.shift();
                p.status = p.queue.length>0 ? "flying" : "idle";

                let profitMultiplier = 1;
                if(currentEvent) profitMultiplier *= currentEvent.multiplier || 1;
                const profit = Math.round(1000*planeTypes[p.type].profitMultiplier*dest.level*profitMultiplier);
                gameState.money += profit;
                notify(`${p.name} arrived at ${dest.name}! Earned $${profit}`);
                planeDeliveredCount++;
                checkAchievements();
                checkMissions();

                if(autoFly && p.queue.length===0){
                    const unlocked = gameState.airports.filter(a=>a.unlocked&&(a.lat!==p.lat||a.lon!==p.lon));
                    if(unlocked.length>0){
                        const next = unlocked[Math.floor(Math.random()*unlocked.length)];
                        p.queue.push(next.name);
                        p.status = "flying";
                        notify(`${p.name} is flying to ${next.name}`);
                    }
                }
            } else {
                const speedFactor = planeTypes[p.type].speed*0.01;
                const travelSpeed = speedFactor * dist; // distance-based speed
                p.lat += dx*travelSpeed;
                p.lon += dy*travelSpeed;
            }

            planeMarkers[p.name].setLatLng([p.lat,p.lon]);
        }
    });
    drawFlightLines();
}

// --- Passive Income ---
function addPassiveIncome(){
    let income=0;
    gameState.airports.forEach(a=>{ if(a.unlocked) income += 100*a.level; });
    gameState.money += income;
    if(income>0) notify(`Passive income: $${income}`);
    updateUI();
}

// --- Game Time ---
function updateTime(){
    gameTime.minutes += 10;
    if(gameTime.minutes >= 60){ gameTime.minutes=0; gameTime.hours++; }
    if(gameTime.hours >= 24){ gameTime.hours=0; gameTime.day++; }
    document.getElementById("gameTime").innerText = `${String(gameTime.hours).
