<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Airplane Tycoon</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  body { margin:0; font-family:sans-serif; }
  #map { height:60vh; width:100%; }
  #ui { padding:10px; background:#f4f4f4; }
  button { margin:2px; padding:5px 10px; }
  .airport-level-small { color: green; }
  .airport-level-medium { color: orange; }
  .airport-level-large { color: red; }
  #notifications { position:fixed; top:10px; left:50%; transform:translateX(-50%); z-index:1000; }
  .notification { background:#333;color:#fff;padding:5px 10px;margin-top:5px;border-radius:5px;opacity:0.9; }
  #profitChart { width:100%; height:200px; }
  input { width:80px; }
</style>
</head>
<body>

<div id="map"></div>
<div id="ui">
  <div>Money: $<span id="money">50000</span></div>
  <div id="airportsUI"></div>
  <div id="planesUI"></div>
  <button onclick="restartGame()">Restart Game</button>
  <label><input type="checkbox" id="autoMaintain" onchange="toggleAutoMaintain()"> Auto-Maintain</label>
</div>
<div id="notifications"></div>
<canvas id="profitChart"></canvas>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// --- Game Data ---
let game = {
  money: 50000,
  airports: [],
  planes: [],
  profitHistory: [],
  autoMaintain: false
};

const airportData = [
  { name: "Los Angeles Intl", code:"LAX", lat:33.9416, lon:-118.4085 },
  { name: "John F. Kennedy", code:"JFK", lat:40.6413, lon:-73.7781 },
  { name: "London Heathrow", code:"LHR", lat:51.4700, lon:-0.4543 },
  { name: "Tokyo Haneda", code:"HND", lat:35.5494, lon:139.7798 },
  { name: "Paris Charles de Gaulle", code:"CDG", lat:49.0097, lon:2.5479 },
  { name: "Dubai Intl", code:"DXB", lat:25.2532, lon:55.3657 },
  { name: "Sydney Kingsford Smith", code:"SYD", lat:-33.9399, lon:151.1753 },
  // Add up to 50 airports as needed
];

// Plane types
const planeTypes = [
  { name:"Tiny Plane", emoji:"✈️", speed:0.5, earn:1000, upgradeCost:20000 },
  { name:"Regional Jet", emoji:"✈️", speed:0.7, earn:5000, upgradeCost:50000 },
  { name:"Boeing 737", emoji:"✈️", speed:1, earn:10000, upgradeCost:100000 },
  { name:"Boeing 747", emoji:"✈️", speed:1.5, earn:25000, upgradeCost:null }
];

// --- Map Setup ---
const map = L.map('map').setView([20,0], 2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
let airportMarkers = {};
let planeMarkers = {};

// --- Notifications ---
function notify(msg){
  const n = document.createElement("div");
  n.className = "notification";
  n.textContent = msg;
  document.getElementById("notifications").appendChild(n);
  setTimeout(()=>n.remove(),3000);
}

// --- Airports ---
function initAirports(){
  if(game.airports.length===0){
    for(let i=0;i<3;i++){
      game.airports.push({ ...airportData[i], level:"Small", unlocked:true });
    }
  }
  updateAirportsUI();
  renderAirports();
}

function renderAirports(){
  for(let code in airportMarkers){
    map.removeLayer(airportMarkers[code]);
  }
  airportMarkers={};
  game.airports.forEach(ap=>{
    if(ap.unlocked){
      const color = ap.level==="Small"?"green":ap.level==="Medium"?"orange":"red";
      const marker = L.circleMarker([ap.lat,ap.lon],{color:color,radius:10}).addTo(map)
        .bindPopup(`<b>${ap.name} (${ap.code})</b><br>Level: ${ap.level}`);
      airportMarkers[ap.code]=marker;
    }
  });
}

function upgradeAirport(index){
  const ap = game.airports[index];
  let cost = ap.level==="Small"?50000:ap.level==="Medium"?100000:0;
  if(game.money>=cost){
    game.money-=cost;
    if(ap.level==="Small") ap.level="Medium";
    else if(ap.level==="Medium") ap.level="Large";
    updateMoney();
    updateAirportsUI();
    renderAirports();
    notify(`${ap.name} upgraded to ${ap.level}`);
  }else notify("Not enough money to upgrade airport");
}

function unlockAirport(index){
  const ap = airportData[index];
  const cost = 50000 + 10000*(game.airports.length-3);
  if(game.money>=cost){
    game.money-=cost;
    game.airports.push({...ap, level:"Small", unlocked:true});
    updateMoney();
    updateAirportsUI();
    renderAirports();
    notify(`${ap.name} unlocked!`);
  }else notify("Not enough money to unlock airport");
}

function updateAirportsUI(){
  const container = document.getElementById("airportsUI");
  container.innerHTML="";
  game.airports.forEach((ap,i)=>{
    const btn = document.createElement("button");
    btn.textContent=`Upgrade ${ap.name} (${ap.level})`;
    btn.onclick=()=>upgradeAirport(i);
    container.appendChild(btn);
  });
  for(let i=3;i<airportData.length;i++){
    if(!game.airports.find(a=>a.code===airportData[i].code)){
      const btn = document.createElement("button");
      btn.textContent=`Unlock ${airportData[i].name} ($${50000 + 10000*(game.airports.length-3)})`;
      btn.onclick=()=>unlockAirport(i);
      container.appendChild(btn);
    }
  }
}

// --- Planes ---
function initPlanes(){
  if(game.planes.length===0){
    game.planes.push({
      name:"My Plane",
      typeIndex:0,
      status:"idle",
      location:game.airports[0].code,
      destination:null,
      autoFly:false,
      rating:100,
      queue:[]
    });
  }
  updatePlanesUI();
  renderPlanes();
}

function updatePlanesUI(){
  const container = document.getElementById("planesUI");
  container.innerHTML="";
  game.planes.forEach((pl,i)=>{
    const div = document.createElement("div");
    div.innerHTML=`${pl.name} (${planeTypes[pl.typeIndex].name}) - Status: ${pl.status==="idle"?"🔴":"🟢"} - Rating: ${pl.rating.toFixed(0)}%`;
    const rename = document.createElement("input");
    rename.value = pl.name;
    rename.onchange = ()=>{pl.name=rename.value; saveGame(); updatePlanesUI();};
    div.appendChild(rename);

    const autoBtn = document.createElement("button");
    autoBtn.textContent=pl.autoFly?"Auto-Fly ON":"Auto-Fly OFF";
    autoBtn.style.backgroundColor=pl.autoFly?"green":"red";
    autoBtn.onclick=()=>{
      pl.autoFly=!pl.autoFly;
      saveGame();
      updatePlanesUI();
    };
    div.appendChild(autoBtn);

    const upgradeBtn = document.createElement("button");
    const nextType = planeTypes[pl.typeIndex+1];
    if(nextType){
      upgradeBtn.textContent=`Upgrade ($${nextType.upgradeCost})`;
      upgradeBtn.onclick=()=>{
        if(game.money>=nextType.upgradeCost){
          game.money-=nextType.upgradeCost;
          pl.typeIndex++;
          updateMoney();
          notify(`${pl.name} upgraded to ${nextType.name}`);
          updatePlanesUI();
        }else notify("Not enough money to upgrade plane");
      };
    }else upgradeBtn.textContent="Max Plane";
    div.appendChild(upgradeBtn);

    container.appendChild(div);
  });
}

function renderPlanes(){
  for(let id in planeMarkers) map.removeLayer(planeMarkers[id]);
  planeMarkers={};
  game.planes.forEach((pl,i)=>{
    const ap = game.airports.find(a=>a.code===pl.location);
    const marker = L.marker([ap.lat,ap.lon]).addTo(map).bindPopup(`${pl.name}`);
    planeMarkers[i]=marker;
  });
}

// --- Plane Queue System ---
function assignFlight(pl, destCode){
  pl.queue.push(destCode);
  if(pl.status==="idle") executeNextFlight(pl);
}

function executeNextFlight(pl){
  if(pl.queue.length===0) return;
  const nextDest = pl.queue.shift();
  startFlight(pl,nextDest);
}

// --- Flight ---
function startFlight(pl, destCode){
  pl.destination = destCode;
  pl.status = "flying";

  const from = game.airports.find(a=>a.code===pl.location);
  const to = game.airports.find(a=>a.code===destCode);
  const distance = getDistance(from.lat,from.lon,to.lat,to.lon);
  const duration = distance * 10 / planeTypes[pl.typeIndex].speed; // distance-based time

  // Draw line
  const line = L.polyline([[from.lat,from.lon],[to.lat,to.lon]], { color: pl.autoFly?'green':'blue', weight:3 }).addTo(map);

  const marker = planeMarkers[game.planes.indexOf(pl)];
  if(marker) marker.setLatLng([from.lat,from.lon]);

  let progress=0;
  const step = 50;
  const flightInterval = setInterval(()=>{
    progress+=step;
    const lat = from.lat + (to.lat-from.lat)*(progress/duration);
    const lon = from.lon + (to.lon-from.lon)*(progress/duration);
    if(marker) marker.setLatLng([lat,lon]);
    if(progress>=duration){
      clearInterval(flightInterval);
      pl.location=destCode;
      pl.status="idle";
      line.remove();
      pl.rating -= Math.random()*5;
      game.money += planeTypes[pl.typeIndex].earn * getAirportMultiplier(to.level);
      notify(`${pl.name} arrived at ${to.name}, earned $${planeTypes[pl.typeIndex].earn * getAirportMultiplier(to.level)}`);
      if(game.autoMaintain && game.money>=1000){
        game.money -= 1000; notify(`${pl.name} auto-maintained`);
      }
      renderPlanes();
      updatePlanesUI();
      executeNextFlight(pl); // Next in queue
    }
  }, step);
}

function getAirportMultiplier(level){ return level==="Small"?1:level==="Medium"?2:3; }

function getDistance(lat1,lon1,lat2,lon2){
  const R = 6371;
  const dLat = (lat2-lat1)*Math.PI/180;
  const dLon = (lon2-lon1)*Math.PI/180;
  const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
  const c = 2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  return R*c;
}

// --- Game Loop ---
function gameTick(){
  // Passive income from airports
  game.airports.forEach(ap=>{
    if(ap.unlocked){
      let income = ap.level==="Small"?500:ap.level==="Medium"?2000:5000;
      game.money+=income;
    }
  });

  // Auto-fly planes
  game.planes.forEach(pl=>{
    if(pl.autoFly && pl.status==="idle"){
      const availableAirports = game.airports.filter(a=>a.code!==pl.location);
      if(availableAirports.length>0){
        const dest = availableAirports[Math.floor(Math.random()*availableAirports.length)];
        assignFlight(pl,dest.code);
      }
    }
  });

  updateMoney();
  updatePlanesUI();
  updateProfitChart();
  saveGame();
}

// --- Money ---
function updateMoney(){ document.getElementById("money").textContent=game.money.toFixed(0); }

// --- Auto-Maintain ---
function toggleAutoMaintain(){ game.autoMaintain=document.getElementById("autoMaintain").checked; saveGame(); }

// --- Restart ---
function restartGame(){
  if(confirm("Are you sure?")){ localStorage.removeItem("airplaneTycoon"); location.reload(); }
}

// --- Profit Chart ---
const ctx = document.getElementById('profitChart').getContext('2d');
const profitChart = new Chart(ctx,{ type:'line', data:{labels:[], datasets:[{label:'Money',data:[],borderColor:'blue',fill:false}] }, options:{animation:false} });
function updateProfitChart(){
  game.profitHistory.push(game.money);
  if(game.profitHistory.length>50) game.profitHistory.shift();
  profitChart.data.labels=game.profitHistory.map((v,i)=>i);
  profitChart.data.datasets[0].data=game.profitHistory;
  profitChart.update();
}

// --- Save/Load ---
function saveGame(){ localStorage.setItem("airplaneTycoon",JSON.stringify(game)); }
function loadGame(){
  const data = localStorage.getItem("airplaneTycoon");
  if(data){ game=JSON.parse(data); }
}

// --- Init ---
loadGame();
initAirports();
initPlanes();
setInterval(gameTick,2000);
</script>

</body>
</html>
