<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Airplane Tycoon</title>
<style>
html, body { height: 100%; margin: 0; font-family: sans-serif; }
#map { height: 50%; width: 100%; }
#ui { padding: 10px; background: #f0f0f0; }
button { margin: 3px; padding: 5px 10px; cursor: pointer; }
.green { background: #4CAF50; color: white; }
.orange { background: orange; color: white; }
.red { background: #f44336; color: white; }
#notifications { position: fixed; top: 10px; left: 50%; transform: translateX(-50%); z-index: 999; }
.notification { background: #333; color: #fff; padding: 5px 10px; margin: 5px; border-radius: 3px; opacity: 0.9; }
#chartContainer { width: 100%; height: 150px; margin-top:10px; }
input.rename-plane { width: 80px; }
</style>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<div id="map"></div>
<div id="ui">
  <div>Money: $<span id="money">0</span></div>
  <div id="airport-list"></div>
  <div id="plane-list"></div>
  <button id="buy-plane" class="green">Buy Plane ($50,000)</button>
  <button id="auto-maintain" class="green">Auto-Maintain: ON</button>
  <button id="restart" class="red">Restart</button>
  <canvas id="profitChart"></canvas>
</div>
<div id="notifications"></div>

<script>
// =======================
// Game Data
// =======================
let game = { money:150000, airports:[], planes:[], timeInterval:1000, passiveIncomeInterval:5000, nextPlaneId:1, profitHistory:[] };

// =======================
// Airports
// =======================
const allAirports = [
  {name:"Los Angeles", code:"LAX", lat:33.9416, lng:-118.4085},
  {name:"New York JFK", code:"JFK", lat:40.6413, lng:-73.7781},
  {name:"London Heathrow", code:"LHR", lat:51.4700, lng:-0.4543},
  {name:"Tokyo Haneda", code:"HND", lat:35.5494, lng:139.7798},
  {name:"Sydney", code:"SYD", lat:-33.9399, lng:151.1753},
  {name:"Paris CDG", code:"CDG", lat:49.0097, lng:2.5479},
  {name:"Dubai", code:"DXB", lat:25.2532, lng:55.3657}
];
const airportLevels = ["Small","Medium","Large"];
const airportColors = ["green","orange","red"];
const airportBaseUnlockCost = 50000;
const airportExtraCost = 10000;

// =======================
// Planes
// =======================
const planeTypes = [
  {name:"Tiny Plane", speed:200, capacity:50, baseEarning:5000, upgradeCost:100000, next:"Regional Jet"},
  {name:"Regional Jet", speed:400, capacity:100, baseEarning:15000, upgradeCost:300000, next:"Boeing 737"},
  {name:"Boeing 737", speed:600, capacity:180, baseEarning:40000, upgradeCost:600000, next:"Boeing 747"},
  {name:"Boeing 747", speed:900, capacity:400, baseEarning:100000, upgradeCost:1000000, next:null}
];

// =======================
// Map Init
// =======================
let map = L.map('map').setView([20,0],2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
let airportMarkers = {}, planeMarkers = {};
let autoMaintain=true;

// =======================
// Notifications
// =======================
function notify(text){
  const div = document.createElement('div');
  div.className='notification';
  div.textContent=text;
  document.getElementById('notifications').appendChild(div);
  setTimeout(()=>div.remove(),3000);
}

// =======================
// Save/Load
// =======================
function saveGame(){ localStorage.setItem('airplaneTycoonSave',JSON.stringify(game)); }
function loadGame(){
  const saved = JSON.parse(localStorage.getItem('airplaneTycoonSave'));
  if(saved){ game=saved; } 
  else{
    // First 3 airports
    game.airports = allAirports.slice(0,3).map(a=>({...a, level:0}));
    // First plane
    game.planes.push({id:game.nextPlaneId++, name:"Plane 1", type:"Tiny Plane", status:"idle", lat:game.airports[0].lat, lng:game.airports[0].lng, queue:[], autoFly:true});
    saveGame();
  }
}
loadGame();

// =======================
// Distance
// =======================
function distance(lat1,lng1,lat2,lng2){
  const R=6371; const dLat=(lat2-lat1)*Math.PI/180; const dLng=(lng2-lng1)*Math.PI/180;
  const a=Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLng/2)**2;
  const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  return R*c;
}

// =======================
// Map & UI
// =======================
function renderUI(){
  document.getElementById('money').textContent=game.money.toLocaleString();
  // Airports
  const airportDiv=document.getElementById('airport-list'); airportDiv.innerHTML='';
  game.airports.forEach((a,i)=>{
    const btn = document.createElement('button');
    btn.className=airportColors[a.level]; btn.textContent=`${a.name} (${a.code}) Lvl: ${airportLevels[a.level]}`;
    airportDiv.appendChild(btn);
  });
  // Planes
  const planeDiv=document.getElementById('plane-list'); planeDiv.innerHTML='';
  game.planes.forEach(p=>{
    const btn = document.createElement('div');
    btn.innerHTML=`${p.name} ${p.type} ${p.status==="flying"?"🟢":"🔴"} `;
    // Rename
    const input = document.createElement('input'); input.className='rename-plane'; input.value=p.name;
    input.addEventListener('change',()=>{ p.name=input.value; saveGame(); renderUI(); });
    btn.appendChild(input);
    // Manual fly select
    const select = document.createElement('select');
    game.airports.forEach(a=>{
      if(a.code!==p.queue[p.queue.length-1]) select.innerHTML+=`<option value="${a.code}">${a.code}</option>`;
    });
    const addBtn = document.createElement('button'); addBtn.textContent='Add to Queue';
    addBtn.addEventListener('click',()=>{ p.queue.push(select.value); saveGame(); notify(`${p.name} queued to ${select.value}`); flyPlane(p); });
    btn.appendChild(select); btn.appendChild(addBtn);
    planeDiv.appendChild(btn);
  });
}
renderUI();

function updateMap(){
  game.airports.forEach(a=>{
    if(!airportMarkers[a.code]){
      const marker = L.circleMarker([a.lat,a.lng],{color:airportColors[a.level],radius:10}).addTo(map)
        .bindPopup(`${a.name} (${a.code}) Lvl: ${airportLevels[a.level]}`);
      airportMarkers[a.code]=marker;
    }
  });
  game.planes.forEach(p=>{
    if(!planeMarkers[p.id]){
      const marker = L.marker([p.lat,p.lng],{icon:L.divIcon({className:'plane-icon',html:'✈️'})}).addTo(map);
      planeMarkers[p.id]=marker;
    } else planeMarkers[p.id].setLatLng([p.lat,p.lng]);
  });
}
updateMap();

// =======================
// Flight Logic
// =======================
function flyPlane(plane){
  if(plane.queue.length===0){ plane.status="idle"; return; }
  const destCode=plane.queue[0];
  const dest=game.airports.find(a=>a.code===destCode);
  if(!dest){ plane.queue.shift(); return; }
  plane.status="flying";
  const dist=distance(plane.lat,plane.lng,dest.lat,dest.lng);
  const speed=planeTypes.find(pt=>pt.name===plane.type).speed;
  const duration=dist/speed*1000; const steps=Math.max(10,duration/50);
  const deltaLat=(dest.lat-plane.lat)/steps; const deltaLng=(dest.lng-plane.lng)/steps;
  let step=0;
  const interval = setInterval(()=>{
    plane.lat+=deltaLat; plane.lng+=deltaLng; step++;
    updateMap();
    if(step>=steps){
      clearInterval(interval);
      plane.lat=dest.lat; plane.lng=dest.lng; plane.queue.shift();
      const earning=Math.floor(speed*dist*10); game.money+=earning; notify(`${plane.name} arrived at ${dest.code} earning $${earning.toLocaleString()}`);
      plane.status="idle";
      // Auto-maintain
      if(autoMaintain) notify(`${plane.name} auto-maintained`);
      saveGame(); renderUI();
      if(plane.autoFly && plane.queue.length===0){
        const unlocked=game.airports.map(a=>a.code).filter(c=>c!==dest.code);
        if(unlocked.length>0){ plane.queue.push(unlocked[Math.floor(Math.random()*unlocked.length)]); flyPlane(plane);}
      } else if(plane.queue.length>0) flyPlane(plane);
    }
  },50);
}

// =======================
// Game Tick & Passive Income
// =======================
function gameTick(){
  game.planes.forEach(p=>{ if(p.status==="idle" && p.queue.length>0) flyPlane(p); });
  renderUI();
  saveGame();
  // Passive income
  game.airports.forEach(a=>{
    const income=(a.level+1)*1000;
    game.money+=income;
  });
  // Track profit history
  game.profitHistory.push(game.money);
  if(game.profitHistory.length>50) game.profitHistory.shift();
  updateChart();
}
setInterval(gameTick, game.timeInterval);

// =======================
// Profit Chart
// =======================
const ctx=document.getElementById('profitChart').getContext('2d');
const profitChart = new Chart(ctx,{ type:'line', data:{ labels:[], datasets:[{label:'Money',data:[],borderColor:'blue',fill:false}]}, options:{responsive:true,animation:false,plugins:{legend:{display:false}},scales:{x:{display:false}}}});
function updateChart(){
  profitChart.data.labels=game.profitHistory.map((v,i)=>i);
  profitChart.data.datasets[0].data=game.profitHistory;
  profitChart.update();
}

// =======================
// UI Buttons
// =======================
document.getElementById('restart').addEventListener('click',()=>{ if(confirm("Restart game?")){ localStorage.removeItem('airplaneTycoonSave'); location.reload(); }});
document.getElementById('buy-plane').addEventListener('click',()=>{
  if(game.money>=50000){
    game.money-=50000;
    game.planes.push({id:game.nextPlaneId++, name:`Plane ${game.nextPlaneId}`, type:"Tiny Plane", status:"idle", lat:game.airports[0].lat, lng:game.airports[0].lng, queue:[], autoFly:true});
    notify('Bought a new plane!');
    saveGame(); renderUI(); updateMap();
  } else notify('Not enough money to buy plane.');
});
document.getElementById('auto-maintain').addEventListener('click',()=>{
  autoMaintain=!autoMaintain; document.getElementById('auto-maintain').textContent=`Auto-Maintain: ${autoMaintain?"ON":"OFF"}`;
});

// =======================
// Initial Render
// =======================
renderUI();
updateMap();
</script>
</body>
</html>
