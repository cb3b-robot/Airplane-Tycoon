<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Airplane Tycoon</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
body { margin:0; display:flex; font-family:sans-serif; height:100vh; }
#panel { width:300px; background:#f0f0f0; padding:10px; overflow-y:auto; }
#map { flex:1; height:100vh; min-width:0; width:100%; }
button { margin:5px 0; width:100%; padding:5px; }
h2,h3 { margin:5px 0; }
.airport-item, .plane-item { margin-bottom:3px; cursor:pointer; display:flex; justify-content:space-between; }
.airport-item:hover, .plane-item:hover { background:#ddd; }
#tutorial {
  background: rgba(0,0,0,0.9);
  color:#fff;
  position:fixed;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  padding:20px;
  display:none;
  max-width:300px;
  z-index:10000;
  border-radius:10px;
  box-shadow:0 0 10px rgba(0,0,0,0.5);
}
#gotit-btn {
  margin-top:10px;
  padding:5px 10px;
  background:#4CAF50;
  color:white;
  border:none;
  border-radius:5px;
  cursor:pointer;
}
#gotit-btn:hover { background:#45a049; }
#notification {
  position:fixed; top:10px; left:50%; transform:translateX(-50%);
  background:rgba(0,0,0,0.8); color:white; padding:10px 20px; border-radius:5px;
  display:none; z-index:9999; font-family:sans-serif;
}
</style>
</head>
<body>

<div id="panel">
  <h2>Airplane Tycoon</h2>
  <h3>Money: $<span id="money">0</span></h3>
  
  <h3>Airports</h3>
  <div id="airports-list"></div>
  <button id="unlock-airport-btn">Unlock Airport ($20,000)</button>
  
  <h3>Planes</h3>
  <div id="planes-list"></div>
  <button id="buy-plane-btn">Buy Tiny Plane ($1,000)</button>

  <button id="tutorial-btn">Tutorial</button>
  <button id="restart-btn" style="background:#f44336;color:white; margin-top:10px; font-weight:bold;">Restart Game</button>
</div>

<div id="map"></div>

<div id="tutorial">
  <h3>Tutorial</h3>
  <p>1. Start with 3 unlocked airports.<br>
  2. Buy a plane and click it to select.<br>
  3. Click an airport to assign the route.<br>
  4. Planes generate passive income, collect manually too.<br>
  5. Upgrade planes to make them stronger.<br>
  6. Planes need maintenance after each route!<br>
  7. Unlock more airports to expand your airline!<br>
  8. Missions give bonus money, complete them to earn extra.<br>
  9. Random events and passenger ratings affect your income!</p>
  <button id="gotit-btn">Got it</button>
</div>

<div id="notification"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
// --- Game Data ---
let money = parseInt(localStorage.getItem('money')) || 25000;
let unlockedAirports = JSON.parse(localStorage.getItem('unlockedAirports')) || ['JFK','LAX','LHR'];
let planes = JSON.parse(localStorage.getItem('planes')) || [];

const airports = {
  'JFK': {name:'John F. Kennedy Intl', lat:40.6413, lng:-73.7781},
  'LAX': {name:'Los Angeles Intl', lat:33.9416, lng:-118.4085},
  'LHR': {name:'London Heathrow', lat:51.4700, lng:-0.4543},
  'CDG': {name:'Paris Charles de Gaulle', lat:49.0097, lng:2.5479},
  'HND': {name:'Tokyo Haneda', lat:35.5494, lng:139.7798},
  'ORD': {name:'Chicago O\'Hare', lat:41.9742, lng:-87.9073},
  'ATL': {name:'Hartsfield-Jackson Atlanta', lat:33.6407, lng:-84.4277},
  'DXB': {name:'Dubai Intl', lat:25.2532, lng:55.3657},
  'SIN': {name:'Singapore Changi', lat:1.3644, lng:103.9915},
  'SYD': {name:'Sydney Kingsford Smith', lat:-33.9399, lng:151.1753},
  'FRA': {name:'Frankfurt Intl', lat:50.0379, lng:8.5622},
  'AMS': {name:'Amsterdam Schiphol', lat:52.3105, lng:4.7683},
  'YYZ': {name:'Toronto Pearson', lat:43.6777, lng:-79.6248},
  'ICN': {name:'Incheon Intl', lat:37.4602, lng:126.4407},
  'MEX': {name:'Mexico City Intl', lat:19.4361, lng:-99.0719},
  'GRU': {name:'São Paulo Guarulhos', lat:-23.4356, lng:-46.4731},
  'SFO': {name:'San Francisco Intl', lat:37.6188, lng:-122.375},
  'SEA': {name:'Seattle-Tacoma Intl', lat:47.4502, lng:-122.3088},
  'CLT': {name:'Charlotte Douglas', lat:35.2140, lng:-80.9431},
  'MIA': {name:'Miami Intl', lat:25.7933, lng:-80.2906},
  'LGW': {name:'London Gatwick', lat:51.1537, lng:-0.1821},
  'MAD': {name:'Madrid Barajas', lat:40.4983, lng:-3.5676},
  'BCN': {name:'Barcelona El Prat', lat:41.2974, lng:2.0833},
  'NRT': {name:'Narita Intl', lat:35.7767, lng:140.3186},
  'BKK': {name:'Suvarnabhumi Bangkok', lat:13.6900, lng:100.7501},
  'KUL': {name:'Kuala Lumpur Intl', lat:2.7456, lng:101.7101},
  'DEL': {name:'Indira Gandhi Intl', lat:28.5562, lng:77.1000},
  'JNB': {name:'O. R. Tambo Intl', lat:-26.1337, lng:28.2420},
  'CPT': {name:'Cape Town Intl', lat:-33.9648, lng:18.6017},
  'SYR': {name:'Syracuse Hancock Intl', lat:43.1112, lng:-76.1063}
};

const planeLevels = [
  {name:'Tiny Plane', income:50, upgradeCost:2000, speed:1},
  {name:'Regional Jet', income:200, upgradeCost:10000, speed:1.5},
  {name:'Boeing 737', income:1000, upgradeCost:50000, speed:2},
  {name:'Boeing 747', income:5000, upgradeCost:null, speed:3}
];

const airportCost = 20000;

// --- Map ---
const map = L.map('map').setView([20,0],2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'© OpenStreetMap contributors'}).addTo(map);

const airportMarkers = {};
for(const code in airports){
  const marker = L.marker([airports[code].lat, airports[code].lng])
    .addTo(map)
    .bindPopup(`${airports[code].name} (${code})`);
  airportMarkers[code] = marker;
  if(!unlockedAirports.includes(code)) marker.setOpacity(0.3);
}

// --- UI ---
const moneyEl = document.getElementById('money');
const airportsListEl = document.getElementById('airports-list');
const planesListEl = document.getElementById('planes-list');
const tutorialDiv = document.getElementById('tutorial');

let planeRoutes = [];
let planeMarkers = [];
let selectedPlaneIndex = null;

// --- Notifications ---
function notify(msg,duration=3000){
  const notification = document.getElementById('notification');
  notification.textContent = msg;
  notification.style.display='block';
  setTimeout(()=>{ notification.style.display='none'; }, duration);
}

// --- Update UI ---
function updateUI(){
  moneyEl.textContent = money;

  airportsListEl.innerHTML = '';
  unlockedAirports.forEach(code=>{
    const div = document.createElement('div');
    div.textContent = `${airports[code].name} (${code})`;
    div.classList.add('airport-item');
    airportsListEl.appendChild(div);
  });

  planesListEl.innerHTML = '';
  if(planes.length===0){
    planesListEl.textContent = 'No planes yet';
  } else {
    planes.forEach((plane,i)=>{
      const level = plane.level || 0;
      const repairCost = 500*(level+1);
      const div = document.createElement('div');
      div.classList.add('plane-item');
      const ratingStars = '★'.repeat(plane.rating||5)+'☆'.repeat(5-(plane.rating||5));
      div.innerHTML = `<span>${plane.type || planeLevels[0].name} (Plane ${i+1}) ${plane.route?'- '+plane.route:''} ${plane.needsMaintenance?'[Needs Maintenance]':''} [${ratingStars}]</span>
      ${planeLevels[level+1]?'<button onclick="upgradePlane('+i+')">Upgrade $'+planeLevels[level+1].upgradeCost+'</button>':''}
      ${plane.needsMaintenance?'<button onclick="repairPlane('+i+')">Repair $'+repairCost+'</button>':''}`;
      planesListEl.appendChild(div);
    });
  }

  updateRoutes();
}

// --- Save ---
function saveGame(){
  localStorage.setItem('money',money);
  localStorage.setItem('unlockedAirports',JSON.stringify(unlockedAirports));
  localStorage.setItem('planes',JSON.stringify(planes));
}

// --- Buy Plane ---
document.getElementById('buy-plane-btn').onclick = ()=>{
  if(money>=planeLevels[0].upgradeCost){
    money -= planeLevels[0].upgradeCost;
    planes.push({ type: planeLevels[0].name, income: planeLevels[0].income, speed: planeLevels[0].speed, level:0, route:null, currentAirport:unlockedAirports[0], maintenance:3, needsMaintenance:false, rating:5, incomeMultiplier:1 });
    saveGame();
    updateUI();
    notify("Tiny Plane purchased!");
  } else notify("Not enough money!");
};

// --- Unlock Airport ---
document.getElementById('unlock-airport-btn').onclick = ()=>{
  for(const code in airports){
    if(!unlockedAirports.includes(code)){
      if(money>=airportCost){
        money -= airportCost;
        unlockedAirports.push(code);
        airportMarkers[code].setOpacity(1);
        saveGame();
        updateUI();
        notify(`${code} unlocked!`);
      } else notify("Not enough money!");
      return;
    }
  }
  notify("No more airports to unlock!");
};

// --- Tutorial ---
document.getElementById('tutorial-btn').onclick = ()=>{ tutorialDiv.style.display='block'; };
document.getElementById('gotit-btn').onclick = ()=>{ tutorialDiv.style.display='none'; };

// --- Restart ---
document.getElementById('restart-btn').onclick = ()=>{
  if(confirm("Restart game? All progress lost.")){
    money = 25000; unlockedAirports=['JFK','LAX','LHR']; planes=[]; 
    for(const code in airportMarkers){ airportMarkers[code].setOpacity(unlockedAirports.includes(code)?1:0.3);}
    saveGame();
    updateUI();
    notify("Game restarted!");
  }
};

// --- Upgrade Plane ---
function upgradePlane(index){
  const plane = planes[index];
  const currentLevel = plane.level || 0;
  const nextLevel = planeLevels[currentLevel+1];
  if(!nextLevel){ notify("Plane at max level!"); return; }
  if(money >= nextLevel.upgradeCost){
    money -= nextLevel.upgradeCost;
    plane.level = currentLevel+1;
    plane.type = nextLevel.name;
    plane.income = nextLevel.income;
    plane.speed = nextLevel.speed;
    saveGame();
    updateUI();
    notify(`${plane.type} upgraded!`);
  } else notify("Not enough money to upgrade!");
}

// --- Repair Plane ---
function repairPlane(index){
  const plane = planes[index];
  if(!plane.needsMaintenance) return;
  const cost = 500*(plane.level+1);
  if(money>=cost){
    money -= cost;
    plane.maintenance = 3;
    plane.needsMaintenance = false;
    saveGame();
    updateUI();
    notify(`Plane ${index+1} repaired!`);
  } else notify("Not enough money to repair!");
}

// --- Plane Selection ---
planesListEl.addEventListener('click',e=>{
  if(e.target.classList.contains('plane-item') || e.target.parentElement.classList.contains('plane-item')){
    const el = e.target.classList.contains('plane-item')?e.target:e.target.parentElement;
    selectedPlaneIndex = Array.from(planesListEl.children).indexOf(el);
    notify(`Selected Plane ${selectedPlaneIndex+1}. Click an airport to assign route.`);
  }
});

// --- Assign Route ---
airportsListEl.addEventListener('click',e=>{
  if(selectedPlaneIndex !== null && e.target.classList.contains('airport-item')){
    const airportText = e.target.textContent;
    const airportCode = airportText.match(/\((.*?)\)/)[1];
    const plane = planes[selectedPlaneIndex];
    if(plane.needsMaintenance){ notify("Plane needs maintenance!"); return; }
    if(unlockedAirports.includes(airportCode)){
      plane.route = airportCode;
      selectedPlaneIndex = null;
      saveGame();
      updateUI();
      notify(`Plane assigned to ${airportCode}`);
    } else notify("Airport locked!");
  }
});

// --- Passive Income ---
setInterval(()=>{
  planes.forEach(p=>money+=p.income*p.incomeMultiplier);
  saveGame();
  updateUI();
},5000);

// --- Plane Routes & Movement ---
function updateRoutes(){
  planeRoutes.forEach(l=>map.removeLayer(l));
  planeMarkers.forEach(m=>map.removeLayer(m));
  planeRoutes=[]; planeMarkers=[];
  planes.forEach((plane,i)=>{
    if(plane.route && !plane.needsMaintenance){
      const startCode = plane.currentAirport;
      const endCode = plane.route;
      const line = L.polyline([[airports[startCode].lat,airports[startCode].lng],[airports[endCode].lat,airports[endCode].lng]],{color:'blue'}).addTo(map);
      planeRoutes.push(line);
      const planeIcon = L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/512/69/69524.png',iconSize:[25,25]});
      const marker = L.marker([airports[startCode].lat,airports[startCode].lng],{icon:planeIcon}).addTo(map);
      planeMarkers.push(marker);

      // Animate
      let progress=0, steps=100/plane.speed;
      const latStep = (airports[endCode].lat - airports[startCode].lat)/steps;
      const lngStep = (airports[endCode].lng - airports[startCode].lng)/steps;
      const interval = setInterval(()=>{
        if(progress>=steps){
          clearInterval(interval);
          marker.setLatLng([airports[endCode].lat,airports[endCode].lng]);
          plane.currentAirport=endCode;
          plane.maintenance -= 1;
          if(plane.maintenance <=0) plane.needsMaintenance = true;
          // Adjust rating
          if(plane.needsMaintenance) plane.rating = Math.max(1,(plane.rating||5)-1);
          // Reset income multiplier
          plane.incomeMultiplier = 1;
          saveGame();
        } else {
          marker.setLatLng([airports[startCode].lat+latStep*progress,airports[startCode].lng+lngStep*progress]);
          progress++;
        }
      },50);
    }
  });
}

// --- Random Events ---
function randomEvent(){
  const events = [
    {msg:'Storm at LAX! Flights delayed.', effect:()=>{ planes.forEach(p=>{ if(p.route==='LAX') p.route=null; }); }},
    {msg:'Fuel prices spike! Repair costs doubled for next 3 flights.', effect:()=>{ planes.forEach(p=>p.fuelSurge=true); }},
    {msg:'Airport strike at JFK! Plane cannot depart this airport this round.', effect:()=>{ planes.forEach(p=>{ if(p.currentAirport==='JFK') p.route=null; }); }},
    {msg:'Good press! Passenger demand increases, income +50% for 1 round.', effect:()=>{ planes.forEach(p=>p.incomeMultiplier=1.5); }},
  ];
  const e = events[Math.floor(Math.random()*events.length)];
  e.effect();
  notify('Event: '+e.msg,5000);
}
setInterval(randomEvent,60000);

// --- Missions ---
let activeMission = null;
function generateMission(){
  const airportKeys = Object.keys(airports);
  const start = airportKeys[Math.floor(Math.random()*airportKeys.length)];
  const end = airportKeys[Math.floor(Math.random()*airportKeys.length)];
  if(start===end) return generateMission();
  activeMission = {start,end,reward:5000,completed:false};
  notify(`Mission: Fly ${start} → ${end
